(this.webpackJsonptwistyeditor=this.webpackJsonptwistyeditor||[]).push([[0],{105:function(e,t,i){e.exports=i(282)},110:function(e,t,i){},282:function(e,t,i){"use strict";i.r(t);var a=i(1),n=i.n(a),r=i(96),o=i.n(r),s=(i(110),i(99)),l=i(4),h=i(6),c=i(12),d=i(11),u=(i(40),i(3)),f=i(0),m=function e(t,i){Object(l.a)(this,e),this.placeable=t,this.renderable=i},p=function(){function e(t,i,a){Object(l.a)(this,e),this.shape=t,this.placeableViews=new Map;var n,r=Object(u.a)(this.shape.prisms);try{for(r.s();!(n=r.n()).done;){var o=n.value;this.placeableViews.set(o.id,this.createPrismView(o,a))}}catch(d){r.e(d)}finally{r.f()}if(i){var s,h=Object(u.a)(this.shape.sections);try{for(h.s();!(s=h.n()).done;){var c=s.value;this.placeableViews.set(c.id,this.createSectionView(c,a))}}catch(d){h.e(d)}finally{h.f()}}this.syncTransform(a)}return Object(h.a)(e,[{key:"createPrismView",value:function(e,t){var i=t.createPrismRenderable(e.colorMask,e.backgroundColor,e.foregroundColor);return new m(e,i)}},{key:"createSectionView",value:function(e,t){var i=t.createSectionRenderable();return new m(e,i)}},{key:"destroy",value:function(e){this.placeableViews.forEach((function(t){return e.destroyRenderable(t.renderable)})),this.placeableViews=null}},{key:"findPlaceableView",value:function(e){return this.placeableViews.get(e)}},{key:"addToScene",value:function(e){this.placeableViews.forEach((function(t){return e.scene.addEntity(t.renderable)}))}},{key:"syncTransform",value:function(e){this.placeableViews.forEach((function(t){return e.setRenderableTransform(t.renderable,t.placeable.worldPosition,t.placeable.worldOrientation)}))}}]),e}(),v=i(20),g=i.n(v),b=f.d.create(),y=f.d.create(),w=f.d.create(),P=f.d.create();function k(e,t,i,a){var n=f.d.sub(b,i,t),r=f.d.sub(y,a,t),o=f.d.cross(w,e.direction,r),s=f.d.dot(n,o);if(!(s<1e-6)){var l=f.d.sub(P,e.origin,t),h=f.d.dot(l,o);if(!(h<0||h>s)){var c=f.d.cross(P,l,n),d=f.d.dot(e.direction,c);if(!(d<0||h+d>s))return f.d.dot(r,c)/s}}}function C(e,t,i){var a=f.d.sub(b,e.origin,t),n=i*i,r=f.d.squaredLength(a);if(r<=n)return 0;var o=f.d.dot(e.direction,e.direction),s=2*f.d.dot(a,e.direction),l=s*s-4*o*(r-n);if(l>=0){var h=Math.sqrt(l),c=(-s-h)/(2*o);return c<0&&(c=(-s+h)/(2*o)),c}}function I(e,t){for(var i=0,a=0,n=0;n<t.length;n++){var r=f.d.dot(e,t[n]);0===n?(i=r,a=r):(r<i&&(i=r),r>a&&(a=r))}return{dmin:i,dmax:a}}function S(e,t,i){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.001;if(0===t.length||0===i.length)return!1;var n=I(e,t),r=I(e,i);return n.dmin+a<r.dmax&&r.dmin+a<n.dmax}function M(e,t){var i=f.d.sub(b,t,e.origin),a=f.d.scale(y,e.direction,f.d.dot(i,e.direction));return f.d.distance(i,a)}var T=i(97),E=i.n(T);function x(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:f.d.create(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:f.c.create();return{position:e,orientation:t}}function R(e,t,i,a){var n=f.c.setAxisAngle(f.c.create(),i,a),r=f.d.sub(f.d.create(),e.position,t);f.d.transformQuat(r,r,n),f.d.add(r,r,t);var o=f.c.mul(n,n,e.orientation);return f.c.normalize(o,o),x(r,o)}function F(e,t,i){return f.d.transformQuat(e.position,i.position,t.orientation),f.d.add(e.position,e.position,t.position),f.c.mul(e.orientation,t.orientation,i.orientation),f.c.normalize(e.orientation,e.orientation),e}function O(e,t){return f.c.invert(e.orientation,t.orientation),f.d.negate(e.position,t.position),f.d.transformQuat(e.position,e.position,e.orientation),e}var V=i(100),A=i(19),j=function(){function e(){Object(l.a)(this,e),this.id=0,this.position=f.d.create(),this.orientation=f.c.create(),this.worldPosition=f.d.create(),this.worldOrientation=f.c.create()}return Object(h.a)(e,[{key:"applyTransform",value:function(e){f.d.transformQuat(this.worldPosition,this.position,e),f.c.multiply(this.worldOrientation,e,this.orientation)}},{key:"translate",value:function(e){f.d.add(this.position,this.position,e)}},{key:"rotate",value:function(e){f.d.transformQuat(this.position,this.position,e),f.c.multiply(this.orientation,e,this.orientation)}},{key:"copy",value:function(e){this.id=e.id,f.d.copy(this.position,e.position),f.c.copy(this.orientation,e.orientation),f.d.copy(this.worldPosition,e.worldPosition),f.c.copy(this.worldOrientation,e.worldOrientation)}}]),e}(),B=Object.freeze({LEFT:0,RIGHT:1,FRONT:2,BACK:3,BOTTOM:4}),J=Math.sqrt(2),L=.5*J,G=[f.d.fromValues(-1,-.5,-L),f.d.fromValues(-1,-.5,L),f.d.fromValues(0,.5,-L),f.d.fromValues(0,.5,L),f.d.fromValues(1,-.5,-L),f.d.fromValues(1,-.5,L)],N=[0,1,2,2,1,3,2,3,4,4,3,5,4,5,0,0,5,1,0,2,4,5,3,1],H=[[0,1,2,3],[2,3,5,4],[1,0,4,5],[0,2,4],[5,3,1]].map((function(e){var t=G[e[0]],i=G[e[1]],a=G[e[2]],n=f.d.sub(f.d.create(),i,t);return f.d.cross(n,n,f.d.sub(f.d.create(),a,t)),f.d.normalize(n,n)})),D=f.d.fromValues(-.5,0,0),Z=f.d.fromValues(.5,0,0),z=f.d.rotateZ(f.d.create(),f.d.fromValues(0,1,0),f.d.fromValues(0,0,0),.25*Math.PI),Q=f.d.rotateZ(f.d.create(),f.d.fromValues(0,1,0),f.d.fromValues(0,0,0),-.25*Math.PI),K=x(f.d.fromValues(-1,0,0),f.c.fromEuler(f.c.create(),-180,0,0)),U=x(f.d.fromValues(1,0,0),f.c.fromEuler(f.c.create(),180,0,0)),W=[{face:B.LEFT,swapColors:!0,pivot:D,normal:z,tangent:Q,transforms:[K,R(K,D,z,.5*Math.PI),R(K,D,z,Math.PI),R(K,D,z,-.5*Math.PI)]},{face:B.RIGHT,swapColors:!0,pivot:Z,normal:Q,tangent:z,transforms:[U,R(U,Z,Q,-.5*Math.PI),R(U,Z,Q,Math.PI),R(U,Z,Q,.5*Math.PI)]},{face:B.FRONT,swapColors:!1,pivot:f.d.fromValues(0,-.5/6,L),normal:f.d.fromValues(0,0,1),tangent:f.d.fromValues(0,1,0),transforms:[x(f.d.fromValues(0,0,J))]},{face:B.BACK,swapColors:!1,pivot:f.d.fromValues(0,-.5/6,-L),normal:f.d.fromValues(0,0,-1),tangent:f.d.fromValues(0,1,0),transforms:[x(f.d.fromValues(0,0,-J))]},{face:B.BOTTOM,swapColors:!1,pivot:f.d.fromValues(0,-.5,0),normal:f.d.fromValues(0,-1,0),tangent:f.d.fromValues(0,0,-1),transforms:[x(f.d.fromValues(0,-1,0),f.c.fromEuler(f.c.create(),180,0,0))]}];function Y(e,t){return f.d.squaredDistance(e,t)<.001}function X(e,t,i,a,n,r,o,s){return Y(e[i],t[r])&&Y(e[a],t[o])&&Y(e[n],t[s])}function q(e,t,i,a,n,r,o,s,l,h){return Y(e[i],t[o])&&Y(e[a],t[s])&&Y(e[n],t[l])&&Y(e[r],t[h])}function _(e,t,i,a,n,r,o,s,l,h){return q(e,t,i,a,n,r,o,s,l,h)||q(e,t,i,a,n,r,s,l,h,o)||q(e,t,i,a,n,r,l,h,o,s)||q(e,t,i,a,n,r,h,o,s,l)}var $=function(e){Object(c.a)(i,e);var t=Object(d.a)(i);function i(){var e;return Object(l.a)(this,i),(e=t.call(this)).colorMask=0,e.backgroundColor="#000",e.foregroundColor="#fff",e.vertices=G.map((function(e){return f.d.clone(e)})),e.polygonNormals=H.map((function(e){return f.d.clone(e)})),e}return Object(h.a)(i,[{key:"applyTransform",value:function(e){Object(V.a)(Object(A.a)(i.prototype),"applyTransform",this).call(this,e);for(var t=0;t<this.vertices.length;t++){var a=this.vertices[t];f.d.transformQuat(a,G[t],this.worldOrientation),f.d.add(a,a,this.worldPosition)}for(var n=0;n<this.polygonNormals.length;n++)f.d.transformQuat(this.polygonNormals[n],H[n],this.worldOrientation)}},{key:"intersect",value:function(e){return function(e,t,i){for(var a,n=0;n<i.length;n+=3){var r=k(e,t[i[n]],t[i[n+1]],t[i[n+2]]);void 0!==r&&(void 0===a||r<a)&&(a=r)}return a}(e,this.vertices,N)}},{key:"collides",value:function(e){return t=this.vertices,i=this.polygonNormals,a=e.vertices,n=e.polygonNormals,i.every((function(e){return S(e,t,a)}))&&n.every((function(e){return S(e,t,a)}));var t,i,a,n}},{key:"getJunctions",value:function(){for(var e=[],t=x(this.position,this.orientation),a=0;a<W.length;a++){for(var n=W[a],r=[],o=0;o<n.transforms.length;o++){var s=F(x(),t,n.transforms[o]),l=new i;l.colorMask=this.colorMask,l.backgroundColor=n.swapColors?this.foregroundColor:this.backgroundColor,l.foregroundColor=n.swapColors?this.backgroundColor:this.foregroundColor,f.d.copy(l.position,s.position),f.c.copy(l.orientation,s.orientation),r.push(l)}var h=f.d.transformQuat(f.d.create(),n.pivot,this.orientation);f.d.add(h,h,this.position);var c=f.d.transformQuat(f.d.create(),n.normal,this.orientation),d=f.d.transformQuat(f.d.create(),n.tangent,this.orientation);e.push({face:n.face,pivot:h,normal:c,tangent:d,prisms:r})}return e}},{key:"coincideFace",value:function(e,t){switch(t){case B.LEFT:if(_(this.vertices,e.vertices,0,1,3,2,4,5,3,2))return B.RIGHT;if(_(this.vertices,e.vertices,0,1,3,2,1,0,2,3))return B.LEFT;break;case B.RIGHT:if(_(this.vertices,e.vertices,2,3,5,4,2,3,1,0))return B.LEFT;if(_(this.vertices,e.vertices,2,3,5,4,3,2,4,5))return B.RIGHT;break;case B.FRONT:if(X(this.vertices,e.vertices,1,3,5,0,2,4))return B.BACK;if(X(this.vertices,e.vertices,1,3,5,5,3,1))return B.FRONT;break;case B.BACK:if(X(this.vertices,e.vertices,0,2,4,1,3,5))return B.FRONT;if(X(this.vertices,e.vertices,0,2,4,4,2,0))return B.BACK;break;case B.BOTTOM:if(q(this.vertices,e.vertices,0,1,5,4,4,5,1,0)||q(this.vertices,e.vertices,0,1,5,4,1,0,4,5))return B.BOTTOM}}},{key:"coincide",value:function(e){for(var t in B){var i=B[t],a=this.coincideFace(e,i);if(void 0!==a)return{baseFace:i,targetFace:a}}}},{key:"toArchive",value:function(){return{id:this.id,colorMask:this.colorMask,backgroundColor:this.backgroundColor,foregroundColor:this.foregroundColor,position:this.position,orientation:this.orientation}}},{key:"fromArchive",value:function(e){this.id=e.id,this.colorMask=e.colorMask,this.backgroundColor=e.backgroundColor,this.foregroundColor=e.foregroundColor,f.d.copy(this.position,e.position),f.c.copy(this.orientation,e.orientation)}},{key:"clone",value:function(){var e=new i;return e.copy(this),e.colorMask=this.colorMask,e.backgroundColor=this.backgroundColor,e.foregroundColor=this.foregroundColor,e}}]),i}(j),ee=180/Math.PI,te=.5*J,ie=.04*Math.cos(Math.PI/4),ae=[f.d.fromValues(2*ie-1+.04,.5-1/3*1-.5+.04,.04-te),f.d.fromValues(2*ie-1+.04,.5-1/3*1-.5+.04,te-.04),f.d.fromValues(0,.5-1/3*1+.5-2*ie,.04-te),f.d.fromValues(0,.5-1/3*1+.5-2*ie,te-.04),f.d.fromValues(1-2*ie-.04,.5-1/3*1-.5+.04,.04-te),f.d.fromValues(1-2*ie-.04,.5-1/3*1-.5+.04,te-.04)],ne=1*J*(1/Math.sqrt(2)),re=1*ne*1,oe=2/9*re,se=1/3*re,le=2/9*re;function he(e,t){return new e.btVector3(t[0],t[1],t[2])}function ce(e,t){return new e.btTransform(function(e,t){return new e.btQuaternion(t[0],t[1],t[2],t[3])}(e,t.orientation),he(e,t.position))}var de=function(){function e(t){var i=this;Object(l.a)(this,e),this.shape=t,E()().then((function(e){i.init(e),i.addGroundBody(e),i.addShapeBody(e,t)}))}return Object(h.a)(e,[{key:"init",value:function(e){this.shapeParts=[],this.prismIds=[],this.prismWorldTransforms=[],this.prismLocalTransforms=[],this.partBtTransform=new e.btTransform,this.partTransform=x(),this.collisionConfiguration=new e.btDefaultCollisionConfiguration,this.dispatcher=new e.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new e.btDbvtBroadphase,this.solver=new e.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new e.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setGravity(new e.btVector3(0,-9.81,0)),this.prismCollisionShape=new e.btConvexHullShape,this.prismCollisionShape.setMargin(.04);var t,i=Object(u.a)(ae);try{for(i.s();!(t=i.n()).done;){var a=t.value;this.prismCollisionShape.addPoint(he(e,a),!1)}}catch(r){i.e(r)}finally{i.f()}this.prismCollisionShape.recalcLocalAabb();var n=x(f.d.fromValues(0,.5-1/3*1,0));this.prismMassOffsetInversed=O(x(),n)}},{key:"addRigidBody",value:function(e,t,i,a,n,r,o,s,l){var h=new e.btDefaultMotionState(ce(e,n)),c=new e.btRigidBodyConstructionInfo(i,h,t,he(e,a));c.set_m_friction(r),c.set_m_restitution(o);var d=new e.btRigidBody(c);return d.setActivationState(4),this.dynamicsWorld.addRigidBody(d,s,l),d}},{key:"addGroundBody",value:function(e){var t=new e.btStaticPlaneShape(new e.btVector3(0,1,0),0);this.addRigidBody(e,t,0,f.d.create(),x(),.5,.5,1,2)}},{key:"addShapeBody",value:function(e,t){for(var i=t.discoverParts(),a=0;a<i.length;a++)console.log("Part "+(a+1)+"/"+i.length+":"),this.addShapePartBody(e,i[a])}},{key:"addShapePartBody",value:function(e,t){if(0!==t.length){var i,a=[],n=f.d.create(),r=Object(u.a)(t);try{for(r.s();!(i=r.n()).done;){var o=i.value,s=F(x(),x(o.worldPosition,o.worldOrientation),this.prismMassOffsetInversed);f.d.add(n,n,s.position),a.push(s)}}catch(z){r.e(z)}finally{r.f()}f.d.scale(n,n,1/t.length);for(var l=f.a.fromValues(0,0,0,0,0,0,0,0,0),h=f.a.create(),c=f.a.create(),d=0,m=a;d<m.length;d++){var p=m[d],v=f.a.fromQuat(h,p.orientation),g=f.a.set(c,v[0]*oe,v[3]*se,v[6]*le,v[1]*oe,v[4]*se,v[7]*le,v[2]*oe,v[5]*se,v[8]*le);f.a.mul(g,v,g),f.a.add(l,l,g);var b=p.position,y=b[0]-n[0],w=b[1]-n[1],P=b[2]-n[2],k=y*y+w*w+P*P;f.a.set(g,k-y*y,-y*w,-y*P,-w*y,k-w*w,-w*P,-P*y,-P*w,k-P*P),f.a.multiplyScalar(g,g,ne),f.a.add(l,l,g)}for(var C=f.c.fromMat3(f.c.create(),function(e,t,i){for(var a=f.a.create(),n=i;n>0;n--){var r=0,o=1,s=2,l=Math.abs(e[3]),h=Math.abs(e[6]);h>l&&(o=2,s=1,l=h),(h=Math.abs(e[7]))>l&&(r=1,o=2,s=0,l=h);var c=t*(Math.abs(e[0])+Math.abs(e[4])+Math.abs(e[8]));if(l<=c)return a;var d,u,m=e[r+3*o],p=(e[o+3*o]-e[r+3*r])/(2*m),v=p*p;c=p>=0?1/(p+Math.sqrt(1+v)):1/(p-Math.sqrt(1+v)),d=1/Math.sqrt(1+c*c),u=d*c,e[r+3*o]=0,e[o+3*r]=0,e[r+3*r]-=c*m,e[o+3*o]+=c*m;var g=e[s+3*r],b=e[s+3*o];e[s+3*r]=e[r+3*s]=d*g-u*b,e[s+3*o]=e[o+3*s]=d*b+u*g;for(var y=0;y<3;y++)g=a[y+3*r],b=a[y+3*o],a[y+3*r]=d*g-u*b,a[y+3*o]=d*b+u*g}return a}(l,1e-5,20)),I=x(n,C),S=f.d.fromValues(l[0],l[4],l[8]),M=O(x(),I),T=new e.btCompoundShape,E=0,R=a;E<R.length;E++){var V=R[E],A=F(x(),M,V);T.addChildShape(ce(e,A),this.prismCollisionShape)}var j,B=t.length*ne,J=this.addRigidBody(e,T,B,S,I,.5,.5,2,3),L=Object(u.a)(t);try{for(L.s();!(j=L.n()).done;){var G=j.value,N=x(f.d.clone(G.worldPosition),f.c.clone(G.worldOrientation)),H=F(x(),M,N);this.prismIds.push(G.id),this.prismWorldTransforms.push(N),this.prismLocalTransforms.push(H)}}catch(z){L.e(z)}finally{L.f()}this.shapeParts.push({partBody:J,prismCount:t.length}),console.log("Mass: "+B),console.log("Origin: {"+n[0].toFixed(2)+", "+n[1].toFixed(2)+", "+n[2].toFixed(2)+"}"),console.log("Inertia: {"+S[0].toFixed(2)+", "+S[1].toFixed(2)+", "+S[2].toFixed(2)+"}");var D=f.d.create(),Z=f.c.getAxisAngle(D,C);console.log("Principal: axis={"+D[0].toFixed(2)+", "+D[1].toFixed(2)+", "+D[2].toFixed(2)+"} angle="+(Z*ee).toFixed(0))}}},{key:"updatePrismTransforms",value:function(){if(this.shapeParts){var e,t=0,i=Object(u.a)(this.shapeParts);try{for(i.s();!(e=i.n()).done;){var a=e.value;a.partBody.getMotionState().getWorldTransform(this.partBtTransform);var n=this.partBtTransform.getOrigin(),r=this.partBtTransform.getRotation();f.d.set(this.partTransform.position,n.x(),n.y(),n.z()),f.c.set(this.partTransform.orientation,r.x(),r.y(),r.z(),r.w());for(var o=0;o<a.prismCount;o++)F(this.prismWorldTransforms[t+o],this.partTransform,this.prismLocalTransforms[t+o]);t+=a.prismCount}}catch(s){i.e(s)}finally{i.f()}}}},{key:"step",value:function(e){this.dynamicsWorld&&(this.dynamicsWorld.stepSimulation(e,10,1/60),this.updatePrismTransforms())}}]),e}(),ue=Math.PI/180,fe=180/Math.PI,me=.48*Math.PI,pe=-Math.PI/10,ve=-Math.PI/40;var ge="res/environment_ibl.ktx",be=function(e){return"res/prism"+e+".png"},ye=function(e){var t=g()(e).toRgb();return[t.r/255,t.g/255,t.b/255]},we=function(e){var t=g()(e).toRgb();return[t.r/255,t.g/255,t.b/255,t.a]},Pe=function(e){Object(c.a)(i,e);var t=Object(d.a)(i);function i(e){var a;return Object(l.a)(this,i),(a=t.call(this,e)).auxMat4=f.b.create(),a}return Object(h.a)(i,[{key:"componentDidMount",value:function(){for(var e=this,t=[ge,"res/prism.filamesh","res/prism.filamat","res/ghost.filamat","res/highcol.filamat","res/knob.filamesh","res/ground.filamat","res/ground.png","res/section.filamesh"],i=0;i<8;i++)t.push(be(i));window.Filament.init(t,(function(){e.init()}))}},{key:"componentDidUpdate",value:function(e){e.mode!==this.props.mode?this.handleModeChange():e.shape!==this.props.shape&&this.handleShapeChange()}},{key:"handleModeChange",value:function(){this.refreshShapeView(),this.props.mode===Oe.SIMULATION?this.simulation=new de(this.props.shape):this.simulation&&(this.simulation=null)}},{key:"handleShapeChange",value:function(){this.props.mode===Oe.EDIT&&this.refreshShapeView()}},{key:"refreshShapeView",value:function(){if(this.engine){this.shapeView&&this.shapeView.destroy(this);var e=this.props.mode===Oe.EDIT;this.shapeView=new p(this.props.shape,e,this),this.shapeView.addToScene(this),this.activePlaceableView=null;var t=this.props.mode===Oe.EDIT?this.props.shape.findPlaceable(this.props.activePlaceableId):null;this.selectPlaceable(t,!0,!1)}}},{key:"init",value:function(){var e=this;this.elevation=pe,this.heading=ve,this.activePlaceableView=null,this.availableJunctions=null,this.focalLengthMin=15,this.focalLengthMax=50,this.cameraZoom=1,this.targetZoom=this.cameraZoom,this.lastZoom=this.cameraZoom,this.focalPoint=f.d.create(),this.targetPosition=f.d.create(),this.lastPosition=f.d.create(),this.highlightColor=[0,0,0,0],this.animationTimer=0,this.highlightTimer=0,this.pressing=!1,this.dragging=!1,this.pickedPlaceable=null,this.pickedJunction=null,this.activeJunctionPrism=null,this.pointerX=0,this.pointerY=0,this.canvas=this.filament;var t=this.engine=window.Filament.Engine.create(this.canvas);this.camera=t.createCamera(window.Filament.EntityManager.get().create()),this.scene=t.createScene();var i=t.createIblFromKtx(ge);i.setIntensity(5e4),this.scene.setIndirectLight(i),this.prismMaterial=t.createMaterial("res/prism.filamat"),this.prismMesh=t.loadFilamesh("res/prism.filamesh"),this.ghostMaterial=t.createMaterial("res/ghost.filamat"),this.ghostRenderable=this.createRenderable(this.createGhostMaterial(),this.prismMesh),this.highcolMaterial=t.createMaterial("res/highcol.filamat"),this.knobMesh=t.loadFilamesh("res/knob.filamesh"),this.knobRenderables=[],this.sectionMesh=t.loadFilamesh("res/section.filamesh"),this.sectionRenderables=[],this.prismTextures=[];for(var a=0;a<8;a++)this.prismTextures.push(t.createTextureFromPng(be(a)));this.prismTextureSampler=new window.Filament.TextureSampler(window.Filament.MinFilter.LINEAR_MIPMAP_LINEAR,window.Filament.MagFilter.LINEAR,window.Filament.WrapMode.CLAMP_TO_EDGE);var n=this.createGround(1e3,4);this.scene.addEntity(n),this.handleShapeChange(),this.swapChain=t.createSwapChain(),this.renderer=t.createRenderer(),this.view=t.createView(),this.view.setCamera(this.camera),this.view.setScene(this.scene),this.renderer.setClearOptions({clearColor:we("#e6e6e6ff"),clear:!0}),this.resize(),this.renderFrame=this.renderFrame.bind(this),this.resize=this.resize.bind(this),window.addEventListener("resize",this.resize),window.requestAnimationFrame(this.renderFrame),this.canvas.addEventListener("pointerdown",(function(t){return e.handlePointerDown(t)})),this.canvas.addEventListener("pointerup",(function(t){return e.handlePointerUp(t)})),this.canvas.addEventListener("pointermove",(function(t){return e.handlePointerMove(t)}))}},{key:"createGround",value:function(e,t){var i=window.Filament.VertexBuffer.Builder().vertexCount(4).bufferCount(2).attribute(window.Filament.VertexAttribute.POSITION,0,window.Filament.VertexBuffer$AttributeType.FLOAT3,0,12).attribute(window.Filament.VertexAttribute.UV0,1,window.Filament.VertexBuffer$AttributeType.FLOAT2,0,8).build(this.engine);i.setBufferAt(this.engine,0,new Float32Array([-e,0,-e,-e,0,e,e,0,-e,e,0,e]));var a=2*e/t;i.setBufferAt(this.engine,1,new Float32Array([0,0,0,a,a,0,a,a]));var n=window.Filament.IndexBuffer.Builder().indexCount(6).bufferType(window.Filament.IndexBuffer$IndexType.USHORT).build(this.engine);n.setBuffer(this.engine,new Uint16Array([0,1,2,2,1,3]));var r=this.engine.createMaterial("res/ground.filamat"),o=this.engine.createTextureFromPng("res/ground.png"),s=new window.Filament.TextureSampler(window.Filament.MinFilter.LINEAR_MIPMAP_LINEAR,window.Filament.MagFilter.LINEAR,window.Filament.WrapMode.REPEAT),l=r.getDefaultInstance();l.setTextureParameter("baseColor",o,s);var h=window.Filament.EntityManager.get().create();return window.Filament.RenderableManager.Builder(1).boundingBox({center:[0,0,0],halfExtent:[e,0,e]}).material(0,l).geometry(0,window.Filament.RenderableManager$PrimitiveType.TRIANGLES,i,n).build(this.engine,h),h}},{key:"createRenderable",value:function(e,t){var i=window.Filament.EntityManager.get().create();return window.Filament.RenderableManager.Builder(1).boundingBox(this.getBoundingBox(t.renderable)).material(0,e).geometry(0,window.Filament.RenderableManager$PrimitiveType.TRIANGLES,t.vertexBuffer,t.indexBuffer).build(this.engine,i),i}},{key:"destroyRenderable",value:function(e){var t=this.getRenderableMaterial(e);this.engine.destroyMaterialInstance(t),this.engine.destroyEntity(e),this.engine.getRenderableManager().destroy(e)}},{key:"createGhostMaterial",value:function(){var e=this.ghostMaterial.createInstance();return e.setColor4Parameter("baseColor",window.Filament.RgbaType.sRGB,we("#90caf960")),e}},{key:"createHighcolMaterial",value:function(e){var t=this.highcolMaterial.createInstance();return t.setColor3Parameter("baseColor",window.Filament.RgbaType.sRGB,ye(e)),t.setColor4Parameter("highlightColor",window.Filament.RgbaType.sRGB,[0,0,0,0]),t}},{key:"createPrismRenderable",value:function(e,t,i){var a=e>=0&&e<8?e:0,n=this.prismMaterial.createInstance();return n.setTextureParameter("colorMask",this.prismTextures[a],this.prismTextureSampler),n.setColor3Parameter("backgroundColor",window.Filament.RgbType.sRGB,ye(t)),n.setColor3Parameter("foregroundColor",window.Filament.RgbType.sRGB,ye(i)),n.setColor4Parameter("highlightColor",window.Filament.RgbaType.sRGB,[0,0,0,0]),this.createRenderable(n,this.prismMesh)}},{key:"createKnobRenderable",value:function(){return this.createRenderable(this.createGhostMaterial(),this.knobMesh)}},{key:"createSectionRenderable",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.createRenderable(e?this.createGhostMaterial():this.createHighcolMaterial("#4caf50"),this.sectionMesh)}},{key:"getBoundingBox",value:function(e){var t=this.engine.getRenderableManager(),i=t.getInstance(e),a=t.getAxisAlignedBoundingBox(i);return i.delete(),a}},{key:"setRenderableTransform",value:function(e,t,i){var a=this.engine.getTransformManager(),n=a.getInstance(e),r=f.b.fromRotationTranslation(this.auxMat4,i,t);a.setTransform(n,r),n.delete()}},{key:"getRenderableMaterial",value:function(e){var t=this.engine.getRenderableManager(),i=t.getInstance(e),a=t.getMaterialInstanceAt(i,0);return i.delete(),a}},{key:"updateCamera",value:function(){var e=[this.focalPoint[0],this.focalPoint[1],this.focalPoint[2]+10];f.d.rotateX(e,e,this.focalPoint,this.elevation),f.d.rotateY(e,e,this.focalPoint,this.heading),this.camera.lookAt(e,this.focalPoint,[0,1,0]);var t,i=this.focalLengthMin*(1-this.cameraZoom)+this.focalLengthMax*this.cameraZoom,a=(t=i,2*Math.atan(16/t)*fe),n=this.canvas.width/this.canvas.height;this.camera.setProjectionFov(a,n,1,300,window.Filament.Camera$Fov.VERTICAL)}},{key:"renderFrame",value:function(e){void 0===this.lastTime&&(this.lastTime=e);var t=.001*(e-this.lastTime);if(this.lastTime=e,this.animationTimer<.3){this.animationTimer+=t;var i=Math.min(this.animationTimer/.3,1),a=i*i*(3-2*i);f.d.lerp(this.focalPoint,this.lastPosition,this.targetPosition,a),this.cameraZoom=this.lastZoom*(1-a)+this.targetZoom*a,this.updateCamera()}if(this.activePlaceableView){this.highlightTimer+=t,this.highlightTimer>2&&(this.highlightTimer%=2);var n=2*Math.abs(this.highlightTimer/2-.5),r=.3+.5*(n*n*(3-2*n));this.setHighlightIntensity(this.activePlaceableView,r)}if(this.props.mode===Oe.SIMULATION){this.simulation.step(t);var o=this.simulation.prismIds;if(o)for(var s=this.simulation.prismWorldTransforms,l=0;l<o.length;l++){var h=this.shapeView.findPlaceableView(o[l]),c=s[l];this.setRenderableTransform(h.renderable,c.position,c.orientation)}}this.renderer.render(this.swapChain,this.view),window.requestAnimationFrame(this.renderFrame)}},{key:"resize",value:function(){var e=window.devicePixelRatio,t=this.canvas.width=.8*window.innerWidth*e,i=this.canvas.height=window.innerHeight*e;if(this.view.setViewport([0,0,t,i]),this.focalLengthMin=15,this.focalLengthMax=50,t<i){var a=t/i;this.focalLengthMin*=a,this.focalLengthMax*=a}this.updateCamera()}},{key:"isPrimaryPointer",value:function(e){return"touch"!==e.pointerType||e.isPrimary}},{key:"handlePointerDown",value:function(e){if(this.isPrimaryPointer(e)){if(this.pickedPlaceable=null,this.pickedJunction=null,this.activeJunctionPrism=null,this.props.mode===Oe.EDIT){var t,i=this.getCastingRay(e.clientX,e.clientY),a=this.shapeView.shape.intersect(i);this.props.activePlaceableId&&(t=this.intersectJunctions(i)),t&&(!a||t.hitDistance<a.hitDistance)?(this.pickedJunction=t.hitJunction,this.pickedJunction.section?this.activatePrismSection(this.availableJunctions,this.pickedJunction):this.activatePrismKnob(this.availableJunctions,this.pickedJunction)):this.pickedPlaceable=a?a.hitPlaceable:null}this.pressing=!0,this.dragging=!1,this.pointerX=e.clientX,this.pointerY=e.clientY}}},{key:"handlePointerUp",value:function(e){this.isPrimaryPointer(e)&&(this.props.mode===Oe.EDIT&&(this.pickedJunction&&this.pickedJunction.section?this.addSection(this.pickedJunction.section):this.activeJunctionPrism?this.addPrism(this.activeJunctionPrism):this.dragging||this.pickedJunction||this.selectPlaceable(this.pickedPlaceable,!0,!0),this.hideGhostPrism(),this.availableJunctions&&(this.showPrismKnobs(this.availableJunctions),this.showPrismSections(this.availableJunctions))),this.pressing=!1)}},{key:"handlePointerMove",value:function(e){if(this.isPrimaryPointer(e)&&this.pressing){var t=e.clientX-this.pointerX,i=e.clientY-this.pointerY;if(this.dragging)if(this.pickedJunction&&!this.pickedJunction.section){var a=this.getCastingRay(e.clientX,e.clientY),n=this.pickNearestJunctionPrism(a,this.pickedJunction);n!==this.activeJunctionPrism&&(this.showGhostPrism(n.worldPosition,n.worldOrientation),this.activeJunctionPrism=n)}else this.pickedJunction||(this.elevation=Math.min(Math.max(this.elevation-.01*i,-me),me),this.heading=(this.heading-.01*t)%(2*Math.PI),this.updateCamera(),this.pointerX=e.clientX,this.pointerY=e.clientY);else t*t+i*i>=9&&(this.pointerX=e.clientX,this.pointerY=e.clientY,this.dragging=!0)}}},{key:"computeAutoZoom",value:function(e){var t,i,a=0,n=f.d.create(),r=f.a.fromMat4(f.a.create(),this.camera.getViewMatrix()),o=this.canvas.height/this.canvas.width,s=Object(u.a)(e.prisms);try{for(s.s();!(t=s.n()).done;){var l,h=t.value,c=Object(u.a)(h.vertices);try{for(c.s();!(l=c.n()).done;){var d=l.value;f.d.sub(n,d,e.aabb.center),f.d.transformMat3(n,n,r);var m=2*Math.atan(1.1*o*Math.abs(n[0])/(10-n[2]))*fe;m>a&&(a=m);var p=2*Math.atan(1.1*Math.abs(n[1])/(10-n[2]))*fe;p>a&&(a=p)}}catch(g){c.e(g)}finally{c.f()}}}catch(g){s.e(g)}finally{s.f()}if(a>0){var v=((i=a,16/Math.tan(.5*i*ue))-this.focalLengthMin)/(this.focalLengthMax-this.focalLengthMin);return Math.min(Math.max(v,0),1)}return 1}},{key:"getCastingRay",value:function(e,t){var i=window.devicePixelRatio,a=2*e*i/this.canvas.width-1,n=1-2*t*i/this.canvas.height,r=f.e.fromValues(a,n,-1,1);f.e.transformMat4(r,r,window.Filament.Camera.inverseProjection(this.camera.getProjectionMatrix())),r[2]=-1,r[3]=0,f.e.transformMat4(r,r,this.camera.getModelMatrix());var o=f.d.fromValues(r[0],r[1],r[2]);return f.d.normalize(o,o),{origin:this.camera.getPosition(),direction:o}}},{key:"intersectJunctions",value:function(e){if(this.availableJunctions){for(var t,i,a=0;a<this.availableJunctions.length;a++){var n=this.availableJunctions[a],r=void 0;void 0!==(r=n.section?n.section.intersect(e):C(e,n.pivot,.4))&&(void 0===i||r<i)&&(t=n,i=r)}if(t)return{hitJunction:t,hitDistance:i}}}},{key:"pickNearestJunctionPrism",value:function(e,t){for(var i,a=null,n=0;n<t.prisms.length;n++){var r=t.prisms[n],o=M(e,r.worldPosition);(void 0===i||o<i)&&(a=r,i=o)}return a}},{key:"selectPlaceable",value:function(e,t,i){this.activePlaceableView&&this.setHighlightIntensity(this.activePlaceableView,0),this.activePlaceableView=e?this.shapeView.findPlaceableView(e.id):null,this.activePlaceableView&&this.updateHighlightColor(e),e instanceof $&&this.activePlaceableView?(this.availableJunctions=this.shapeView.shape.getAvailableJunctions(e),this.showPrismKnobs(this.availableJunctions),this.showPrismSections(this.availableJunctions)):(this.availableJunctions=null,this.hidePrismKnobs(),this.hidePrismSections()),t&&(f.d.copy(this.lastPosition,this.targetPosition),this.lastZoom=this.targetZoom,this.activePlaceableView?(f.d.copy(this.targetPosition,e.worldPosition),this.targetZoom=1):(f.d.copy(this.targetPosition,this.shapeView.shape.aabb.center),this.targetZoom=this.computeAutoZoom(this.shapeView.shape)),this.animationTimer=0,this.highlightTimer=0),i&&this.props.onActivePlaceableChange(e?e.id:0)}},{key:"addPrism",value:function(e){var t=this.shapeView.shape.clone();e.id=++t.lastPlaceableId,t.prisms.push(e),t.applyTransform(),this.props.onShapeChange(t,e.id)}},{key:"addSection",value:function(e){var t=this.shapeView.shape.clone();e.id=++t.lastPlaceableId,t.sections.push(e),t.applyTransform(),this.props.onShapeChange(t,e.id)}},{key:"updateHighlightColor",value:function(e){var t;t=e instanceof $?e.backgroundColor:"#4caf50";var i=g.a.readability(t,"#ffff40")>g.a.readability(t,"#b266ff")?"#ffff40":"#b266ff",a=g()(i).toRgb();this.highlightColor[0]=a.r/255,this.highlightColor[1]=a.g/255,this.highlightColor[2]=a.b/255}},{key:"setHighlightIntensity",value:function(e,t){var i=this.getRenderableMaterial(e.renderable);this.highlightColor[3]=t,i.setColor4Parameter("highlightColor",window.Filament.RgbaType.sRGB,this.highlightColor)}},{key:"setGhostColor",value:function(e,t){this.getRenderableMaterial(e).setColor4Parameter("baseColor",window.Filament.RgbaType.sRGB,we(t))}},{key:"showGhostPrism",value:function(e,t){this.setRenderableTransform(this.ghostRenderable,e,t),this.scene.addEntity(this.ghostRenderable)}},{key:"hideGhostPrism",value:function(){this.scene.remove(this.ghostRenderable)}},{key:"showPrismKnobs",value:function(e){for(;this.knobRenderables.length<e.length;)this.knobRenderables.push(this.createKnobRenderable());for(var t=0;t<e.length;t++){var i=e[t],a=this.knobRenderables[t];this.setGhostColor(a,"#90caf960"),this.setRenderableTransform(a,i.pivot,f.c.create()),this.scene.addEntity(a)}for(var n=e.length;n<this.knobRenderables.length;n++)this.scene.remove(this.knobRenderables[n])}},{key:"activatePrismKnob",value:function(e,t){var i=e.indexOf(t),a=this.knobRenderables[i];this.setGhostColor(a,"#fff59d60"),this.hidePrismKnobs(),this.scene.addEntity(a)}},{key:"hidePrismKnobs",value:function(){var e=this;this.knobRenderables.forEach((function(t){return e.scene.remove(t)}))}},{key:"showPrismSections",value:function(e){var t,i=0,a=Object(u.a)(e);try{for(a.s();!(t=a.n()).done;){var n=t.value;if(n.section){this.sectionRenderables.length<=i&&this.sectionRenderables.push(this.createSectionRenderable(!0));var r=this.sectionRenderables[i];this.setGhostColor(r,"#90caf960"),this.setRenderableTransform(r,n.section.worldPosition,n.section.worldOrientation),this.scene.addEntity(r),i++}}}catch(s){a.e(s)}finally{a.f()}for(var o=i;o<this.sectionRenderables.length;o++)this.scene.remove(this.sectionRenderables[o])}},{key:"activatePrismSection",value:function(e,t){var i,a=-1,n=Object(u.a)(e);try{for(n.s();!(i=n.n()).done;){var r=i.value;if(r.section&&(a++,r===t))break}}catch(s){n.e(s)}finally{n.f()}var o=this.sectionRenderables[a];this.setGhostColor(o,"#fff59d60"),this.hidePrismSections(),this.scene.addEntity(o)}},{key:"hidePrismSections",value:function(){var e=this;this.sectionRenderables.forEach((function(t){return e.scene.remove(t)}))}},{key:"render",value:function(){var e=this;return n.a.createElement("canvas",{className:"Viewport",ref:function(t){return e.filament=t}})}}]),i}(a.Component),ke=i(2),Ce=i.n(ke),Ie=i(98),Se=function(e){Object(c.a)(i,e);var t=Object(d.a)(i);function i(e){var a;return Object(l.a)(this,i),(a=t.call(this,e)).state={displayColorPicker:!1},a}return Object(h.a)(i,[{key:"handleToggleColorPicker",value:function(){this.setState({displayColorPicker:!this.state.displayColorPicker})}},{key:"handleHideColorPicker",value:function(){this.setState({displayColorPicker:!1})}},{key:"handleColorChange",value:function(e){this.props.onChange(e.hex),this.handleHideColorPicker()}},{key:"render",value:function(){var e=this,t=Ce()({default:{color:{width:"36px",height:"14px",borderRadius:"2px",background:this.props.color},swatch:{padding:"5px",background:"#fff",borderRadius:"1px",boxShadow:"0 0 0 1px rgba(0,0,0,.1)",display:"inline-block",cursor:"pointer"},popover:{position:"absolute",zIndex:"2"},cover:{position:"fixed",top:"0px",right:"0px",bottom:"0px",left:"0px"}}});return n.a.createElement("div",null,n.a.createElement("div",{style:t.swatch,onClick:function(){return e.handleToggleColorPicker()}},n.a.createElement("div",{style:t.color})),this.state.displayColorPicker?n.a.createElement("div",{style:t.popover},n.a.createElement("div",{style:t.cover,onClick:function(){return e.handleHideColorPicker()}}),n.a.createElement(Ie.SwatchesPicker,{color:this.props.color,width:"220px",height:"220px",onChange:function(t){return e.handleColorChange(t)}})):null)}}]),i}(a.Component),Me=function(e){Object(c.a)(i,e);var t=Object(d.a)(i);function i(){var e;return Object(l.a)(this,i),(e=t.call(this)).baseFace=void 0,e.targetFace=void 0,e.basePrismId=0,e.targetPrismId=0,e}return Object(h.a)(i,[{key:"intersect",value:function(e){var t=f.d.fromValues(1,0,0);return f.d.transformQuat(t,t,this.worldOrientation),function(e,t){var i=f.d.sub(b,e.direction,f.d.scale(b,t.normal,f.d.dot(e.direction,t.normal))),a=f.d.dot(i,i);if(!(a<1e-12)){var n=f.d.sub(y,e.origin,t.position),r=f.d.sub(w,n,f.d.scale(w,t.normal,f.d.dot(n,t.normal))),o=2*f.d.dot(i,r),s=o*o-4*a*(f.d.dot(r,r)-t.radius*t.radius);if(!(s<0)){var l=Math.sqrt(s),h=1/(2*a),c=h*(-o-l),d=h*(-o+l);if(!(c<0&&d<0)){var u=t.position,m=f.d.add(b,f.d.scale(b,t.normal,t.height),t.position),p=f.d.dot(t.normal,u),v=f.d.dot(t.normal,m);if(c>=0){var g=f.d.add(b,f.d.scale(b,e.direction,c),e.origin),P=f.d.dot(t.normal,g);if((p-P)*(v-P)<0)return c}if(d>=0){var k=f.d.add(b,f.d.scale(b,e.direction,d),e.origin),C=f.d.dot(t.normal,k);if((p-C)*(v-C)<0)return d}}}}}(e,function(e,t,i,a){var n=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=f.d.create();return n?(f.d.scale(r,t,-.5*a),f.d.add(r,r,e)):f.d.copy(r,e),{position:r,normal:f.d.clone(t),radius:i,height:a}}(this.worldPosition,t,1,.3,!0))}},{key:"toArchive",value:function(){return{id:this.id,baseFace:this.baseFace,targetFace:this.targetFace,basePrismId:this.basePrismId,targetPrismId:this.targetPrismId,position:this.position,orientation:this.orientation}}},{key:"fromArchive",value:function(e){this.id=e.id,this.baseFace=e.baseFace,this.targetFace=e.targetFace,this.basePrismId=e.basePrismId,this.targetPrismId=e.targetPrismId,f.d.copy(this.position,e.position),f.c.copy(this.orientation,e.orientation)}},{key:"clone",value:function(){var e=new i;return e.copy(this),e.baseFace=this.baseFace,e.targetFace=this.targetFace,e.basePrismId=this.basePrismId,e.targetPrismId=this.targetPrismId,e}}]),i}(j),Te=function(e){Object(c.a)(i,e);var t=Object(d.a)(i);function i(){return Object(l.a)(this,i),t.apply(this,arguments)}return Object(h.a)(i,[{key:"modifyShape",value:function(e,t){var i=e.clone();t(i),i.applyTransform(),this.props.onShapeChange(i)}},{key:"modifyPrism",value:function(e,t,i){this.modifyShape(e,(function(e){var a=e.findPlaceable(t.id);i(a)}))}},{key:"handleRollChange",value:function(e,t){this.modifyShape(e,(function(e){return e.roll=parseFloat(t)||0}))}},{key:"handlePitchChange",value:function(e,t){this.modifyShape(e,(function(e){return e.pitch=parseFloat(t)||0}))}},{key:"handleYawChange",value:function(e,t){this.modifyShape(e,(function(e){return e.yaw=parseFloat(t)||0}))}},{key:"handleColorMaskChange",value:function(e,t,i){this.modifyPrism(e,t,(function(e){return e.colorMask=parseInt(i)||0}))}},{key:"handleBackgroundColorChange",value:function(e,t,i){this.modifyPrism(e,t,(function(e){return e.backgroundColor=i}))}},{key:"handleForegroundColorChange",value:function(e,t,i){this.modifyPrism(e,t,(function(e){return e.foregroundColor=i}))}},{key:"handleSwapColors",value:function(e,t){this.modifyPrism(e,t,(function(e){e.foregroundColor=t.backgroundColor,e.backgroundColor=t.foregroundColor}))}},{key:"handleDeletePrism",value:function(e,t){this.modifyShape(e,(function(e){e.prisms=e.prisms.filter((function(e){return e.id!==t.id})),e.sections=e.sections.filter((function(e){return e.basePrismId!==t.id&&e.targetPrismId!==t.id}))}))}},{key:"handleDeleteSection",value:function(e,t){this.modifyShape(e,(function(e){e.sections=e.sections.filter((function(e){return e.id!==t.id}))}))}},{key:"renderShapeParams",value:function(e){var t=this;return n.a.createElement("div",{className:"Group"},n.a.createElement("h3",null,"Shape"),n.a.createElement("p",null,n.a.createElement("label",{htmlFor:"roll"},"Roll : "),n.a.createElement("input",{type:"number",id:"roll",name:"roll",min:"-180",max:"180",step:"15",value:e.roll,onChange:function(i){return t.handleRollChange(e,i.target.value)}})),n.a.createElement("p",null,n.a.createElement("label",{htmlFor:"pitch"},"Pitch : "),n.a.createElement("input",{type:"number",id:"pitch",name:"pitch",min:"-180",max:"180",step:"15",value:e.pitch,onChange:function(i){return t.handlePitchChange(e,i.target.value)}})),n.a.createElement("p",null,n.a.createElement("label",{htmlFor:"yaw"},"Yaw : "),n.a.createElement("input",{type:"number",id:"yaw",name:"yaw",min:"-180",max:"180",step:"15",value:e.yaw,onChange:function(i){return t.handleYawChange(e,i.target.value)}})),n.a.createElement("h3",null,"File"),n.a.createElement("p",null,n.a.createElement("button",{id:"resetShape",name:"resetShape",onClick:function(){return t.props.onShapeReset()}},"Reset"),n.a.createElement("button",{id:"showcaseShape",name:"showcaseShape",onClick:function(){return t.props.onShapeShowcase()}},"Showcase")),n.a.createElement("p",null,n.a.createElement("button",{id:"importShape",name:"importShape",onClick:function(){return t.props.onShapeImport()}},"Import"),n.a.createElement("button",{id:"exportShape",name:"exportShape",onClick:function(){return t.props.onShapeExport(e)}},"Export")),n.a.createElement("h3",null,"Simulation"),n.a.createElement("button",{id:"startSimulation",name:"startSimulation",disabled:this.props.mode===Oe.SIMULATION,onClick:function(){return t.props.onSimulationStart()}},"Start"),n.a.createElement("button",{id:"stopSimulation",name:"stopSimulation",disabled:this.props.mode!==Oe.SIMULATION,onClick:function(){return t.props.onSimulationStop()}},"Stop"))}},{key:"renderPrismParams",value:function(e,t){var i=this;return n.a.createElement("div",{className:"Group"},n.a.createElement("h3",null,"Prism"),n.a.createElement("p",null,n.a.createElement("label",{htmlFor:"colorMask"},"Mask : "),n.a.createElement("input",{type:"number",id:"colorMask",name:"colorMask",min:"0",max:7,step:"1",value:t.colorMask,onChange:function(a){return i.handleColorMaskChange(e,t,a.target.value)}})),n.a.createElement("div",null,n.a.createElement("label",{htmlFor:"backgroundColor"},"Background : "),n.a.createElement(Se,{id:"backgroundColor",name:"backgroundColor",color:t.backgroundColor,onChange:function(a){return i.handleBackgroundColorChange(e,t,a)}})),n.a.createElement("div",null,n.a.createElement("label",{htmlFor:"foregroundColor"},"Foreground : "),n.a.createElement(Se,{id:"foregroundColor",name:"foregroundColor",color:t.foregroundColor,onChange:function(a){return i.handleForegroundColorChange(e,t,a)}})),n.a.createElement("p",null,n.a.createElement("button",{id:"swapColors",name:"swapColors",onClick:function(){return i.handleSwapColors(e,t)}},"Swap")),n.a.createElement("p",null,n.a.createElement("button",{id:"deletePrism",name:"deletePrism",disabled:e.prisms.length<=1,onClick:function(){return i.handleDeletePrism(e,t)}},"Delete")))}},{key:"renderSectionParams",value:function(e,t){var i=this;return n.a.createElement("div",{className:"Group"},n.a.createElement("h3",null,"Section"),n.a.createElement("p",null,n.a.createElement("button",{id:"deleteSection",name:"deleteSection",onClick:function(){return i.handleDeleteSection(e,t)}},"Delete")))}},{key:"renderParams",value:function(){var e=this.props.shape.findPlaceable(this.props.activePlaceableId);return e?e instanceof $?this.renderPrismParams(this.props.shape,e):e instanceof Me?this.renderSectionParams(this.props.shape,e):void 0:this.renderShapeParams(this.props.shape)}},{key:"renderHistory",value:function(){var e=this;return n.a.createElement("div",{className:"Group"},n.a.createElement("h3",null,"History"),n.a.createElement("button",{id:"undoHistory",name:"undoHistory",disabled:this.props.historyIndex<=0,onClick:function(){return e.props.onHistoryChange(e.props.historyIndex-1)}},"Undo"),n.a.createElement("button",{id:"redoHistory",name:"redoHistory",disabled:this.props.historyIndex>=this.props.historyEntries.length-1,onClick:function(){return e.props.onHistoryChange(e.props.historyIndex+1)}},"Redo"))}},{key:"render",value:function(){return n.a.createElement("div",{className:"Toolbar"},this.renderHistory(),this.renderParams())}}]),i}(a.Component),Ee=Math.PI/180,xe=function(){function e(){Object(l.a)(this,e),this.prisms=[],this.sections=[],this.lastPlaceableId=0,this.roll=0,this.pitch=0,this.yaw=0,this.aabb={min:f.d.create(),max:f.d.create(),center:f.d.create()}}return Object(h.a)(e,[{key:"getOrientation",value:function(){var e=f.c.create();return f.c.rotateY(e,e,this.yaw*Ee),f.c.rotateX(e,e,this.roll*Ee),f.c.rotateZ(e,e,this.pitch*Ee),e}},{key:"applyTransform",value:function(){for(var e=this.getOrientation(),t=0;t<2;t++){f.d.zero(this.aabb.min),f.d.zero(this.aabb.max);for(var i=0;i<this.prisms.length;i++){var a=this.prisms[i];a.applyTransform(e);for(var n=0;n<a.vertices.length;n++){var r=a.vertices[n];0===i&&0===n?(f.d.copy(this.aabb.min,r),f.d.copy(this.aabb.max,r)):(f.d.min(this.aabb.min,this.aabb.min,r),f.d.max(this.aabb.max,this.aabb.max,r))}}if(0===t){var o=f.c.invert(f.c.create(),e),s=f.d.fromValues(0,.5-this.aabb.min[1],0);f.d.transformQuat(s,s,o),this.translate(s)}else{var l,h=Object(u.a)(this.sections);try{for(h.s();!(l=h.n()).done;){l.value.applyTransform(e)}}catch(c){h.e(c)}finally{h.f()}f.d.add(this.aabb.center,this.aabb.min,this.aabb.max),f.d.scale(this.aabb.center,this.aabb.center,.5)}}}},{key:"translate",value:function(e){this.prisms.forEach((function(t){return t.translate(e)})),this.sections.forEach((function(t){return t.translate(e)}))}},{key:"rotate",value:function(e){this.prisms.forEach((function(t){return t.rotate(e)})),this.sections.forEach((function(t){return t.rotate(e)}))}},{key:"findPlaceable",value:function(e){if(!e)return null;var t,i=Object(u.a)(this.prisms);try{for(i.s();!(t=i.n()).done;){var a=t.value;if(a.id===e)return a}}catch(s){i.e(s)}finally{i.f()}var n,r=Object(u.a)(this.sections);try{for(r.s();!(n=r.n()).done;){var o=n.value;if(o.id===e)return o}}catch(s){r.e(s)}finally{r.f()}return null}},{key:"intersect",value:function(e){var t,i,a,n=Object(u.a)(this.prisms);try{for(n.s();!(a=n.n()).done;){var r=a.value,o=r.intersect(e);void 0!==o&&(void 0===i||o<i)&&(t=r,i=o)}}catch(d){n.e(d)}finally{n.f()}var s,l=Object(u.a)(this.sections);try{for(l.s();!(s=l.n()).done;){var h=s.value,c=h.intersect(e);void 0!==c&&(void 0===i||c<i)&&(t=h,i=c)}}catch(d){l.e(d)}finally{l.f()}if(t)return{hitPlaceable:t,hitDistance:i}}},{key:"getAvailableJunctions",value:function(e){var t=this,i=this.getOrientation(),a=e.getJunctions();return a.forEach((function(a){if(a.prisms.forEach((function(e){return e.applyTransform(i)})),a.prisms=a.prisms.filter((function(i){return t.prisms.every((function(t){return t===e||!t.collides(i)}))})),0===a.prisms.length){var n,r=Object(u.a)(t.prisms);try{var o=function(){var r=n.value;if(r===e)return"continue";var o=e.coincideFace(r,a.face);if(void 0!==o){if(t.sections.some((function(t){return t.basePrismId===e.id&&t.targetPrismId===r.id||t.basePrismId===r.id&&t.targetPrismId===e.id})))return"continue";var s=new Me,l=f.d.cross(f.d.create(),a.normal,a.tangent);return f.d.copy(s.position,a.pivot),f.c.fromMat3(s.orientation,f.a.fromValues(a.normal[0],a.normal[1],a.normal[2],a.tangent[0],a.tangent[1],a.tangent[2],l[0],l[1],l[2])),s.baseFace=a.face,s.targetFace=o,s.basePrismId=e.id,s.targetPrismId=r.id,s.applyTransform(i),a.section=s,"break"}};e:for(r.s();!(n=r.n()).done;){switch(o()){case"continue":continue;case"break":break e}}}catch(s){r.e(s)}finally{r.f()}}f.d.transformQuat(a.pivot,a.pivot,i),f.d.transformQuat(a.normal,a.normal,i),f.d.transformQuat(a.tangent,a.tangent,i)})),a.filter((function(e){return e.prisms.length>0||e.section}))}},{key:"discoverParts",value:function(){var e,t=this,i=[],a=Object(u.a)(this.prisms);try{var n=function(){var a,n=e.value,r=[],o=Object(u.a)(i);try{for(o.s();!(a=o.n()).done;){var s,l=a.value,h=Object(u.a)(l);try{var c=function(){var e=s.value,i=n.coincide(e);if(void 0!==i&&t.sections.every((function(e){return(e.basePrismId!==n.id||e.baseFace!==i.baseFace)&&(e.targetPrismId!==n.id||e.targetFace!==i.baseFace)})))return r.push(l),"break"};for(h.s();!(s=h.n()).done;){if("break"===c())break}}catch(f){h.e(f)}finally{h.f()}}}catch(f){o.e(f)}finally{o.f()}var d=void 0;1===r.length?d=r[0]:r.length>1?(d=[].concat.apply([],r),(i=i.filter((function(e){return!r.includes(e)}))).push(d)):(d=[],i.push(d)),d.push(n)};for(a.s();!(e=a.n()).done;)n()}catch(r){a.e(r)}finally{a.f()}return i}},{key:"toArchive",value:function(){return{prisms:this.prisms.map((function(e){return e.toArchive()})),sections:this.sections.map((function(e){return e.toArchive()})),lastPlaceableId:this.lastPlaceableId,roll:this.roll,pitch:this.pitch,yaw:this.yaw}}},{key:"fromArchive",value:function(e,t){this.prisms=e.prisms.map((function(e){var t=new $;return t.fromArchive(e),t})),t<2?this.lastPlaceableId=e.lastPrismId:(this.sections=e.sections.map((function(e){var t=new Me;return t.fromArchive(e),t})),this.lastPlaceableId=e.lastPlaceableId),this.roll=e.roll,this.pitch=e.pitch,this.yaw=e.yaw}},{key:"clone",value:function(){var t,i=new e,a=Object(u.a)(this.prisms);try{for(a.s();!(t=a.n()).done;){var n=t.value;i.prisms.push(n.clone())}}catch(l){a.e(l)}finally{a.f()}var r,o=Object(u.a)(this.sections);try{for(o.s();!(r=o.n()).done;){var s=r.value;i.sections.push(s.clone())}}catch(l){o.e(l)}finally{o.f()}return i.lastPlaceableId=this.lastPlaceableId,i.roll=this.roll,i.pitch=this.pitch,i.yaw=this.yaw,f.d.copy(i.aabb.min,this.aabb.min),f.d.copy(i.aabb.max,this.aabb.max),f.d.copy(i.aabb.center,this.aabb.center),i}}],[{key:"createInitialShape",value:function(){var t=new e,i=new $;return i.id=++t.lastPlaceableId,i.backgroundColor="#1976d2",i.foregroundColor="#d9d9d9",t.prisms.push(i),t.applyTransform(),t}}]),e}(),Re=Math.PI/180,Fe=function(){function e(){Object(l.a)(this,e),this.pieceCount=0,this.shape=new xe}return Object(h.a)(e,[{key:"addPrism",value:function(e,t,i){var a;this.shape.prisms.length>0?a=this.shape.prisms[this.shape.prisms.length-1].getJunctions()[1].prisms[0]:a=new $;a.id=++this.shape.lastPlaceableId,a.colorMask=e,a.backgroundColor=t,a.foregroundColor=i,this.shape.prisms.push(a),this.pieceCount++}},{key:"fold",value:function(e){var t,i=e.split("-"),a=Object(u.a)(i);try{for(a.s();!(t=a.n()).done;){var n=t.value,r=void 0,o=void 0;if(-1!==(r=n.indexOf("L")))o=!0;else{if(-1===(r=n.indexOf("R")))return!1;o=!1}var s=n.substring(0,r);if(!s)return!1;var l=2*(parseInt(s,10)-1);if(l<0||l>=this.pieceCount)return!1;var h=n.substring(r+1);if(!h)return!1;var c=parseInt(h,10);if(c){if(c<1||c>3)return!1;if(c<3){for(var d=0;d<c;d++)if(!this.twist(l,o,o))return!1}else if(!this.twist(l,o,!o))return!1}}}catch(f){a.e(f)}finally{a.f()}return!0}},{key:"twist",value:function(e,t,i){if(e<0||e>=this.pieceCount)return!1;var a=this.shape.prisms[e].getJunctions(),n=t?a[0]:a[1],r=(i?1:-1)*Math.PI/2;if(t)for(var o=e-1;o>=0;o--)this.twistPrism(o,n.pivot,n.normal,r);else for(var s=e+1;s<this.pieceCount;s++)this.twistPrism(s,n.pivot,n.normal,r);return!0}},{key:"twistPrism",value:function(e,t,i,a){var n=this.shape.prisms[e],r=R(x(n.position,n.orientation),t,i,a);f.d.copy(n.position,r.position),f.c.copy(n.orientation,r.orientation)}},{key:"applyRotations",value:function(e){if(0===e.length)return!0;var t,i=f.c.create(),a=f.c.create(),n=f.d.create(),r=Object(u.a)(e);try{for(r.s();!(t=r.n()).done;){var o=t.value;if(4!==o.length)return!1;f.d.set(n,o[0],o[2],-o[1]),f.d.normalize(n,n),f.c.setAxisAngle(a,n,o[3]*Re),f.c.multiply(i,a,i)}}catch(s){r.e(s)}finally{r.f()}return this.shape.rotate(i),!0}}],[{key:"build",value:function(t,i){var a=i.definitions.find((function(e){return e.name===t}));if(a){var n=e.compileSkin(a.skin,i);if(n){for(var r=new e,o=0;o<a.pieces;o++){var s=n.colors[o%n.colors.length];r.addPrism(n.mask,s[0],s[1])}if(r.fold(a.notation)&&r.applyRotations(a.rotations)){var l=r.shape;return l.applyTransform(),l.translate(f.d.negate(f.d.create(),l.aabb.center)),l.applyTransform(),l}}}}},{key:"compileSkin",value:function(e,t){var i="~"===e.charAt(0)?1:0,a=e.lastIndexOf(":"),n=e.substring(i,-1!==a?a:e.length),r=t.skins.definitions.find((function(e){return e.name===n}));if(r){var o=t.skins.patterns.find((function(e){return e.key===r.pattern}));if(o){var s,l=-1===a?r.mask:parseInt(e.substring(a+1)),h=[],c=Object(u.a)(o.value);try{for(c.s();!(s=c.n()).done;){var d,f=s.value,m=[],p=Object(u.a)(f);try{var v=function(){var e=d.value;if(e<1||e>r.colors.length)return{v:void 0};var i=r.colors[e-1],a=t.skins.colors.find((function(e){return e.key===i}));if(!a)return{v:void 0};m.push(a.value)};for(p.s();!(d=p.n()).done;){var g=v();if("object"===typeof g)return g.v}}catch(b){p.e(b)}finally{p.f()}h.push(m)}}catch(b){c.e(b)}finally{c.f()}return i>0&&h.reverse(),{mask:l,colors:h}}}}}]),e}(),Oe=Object.freeze({EDIT:0,SIMULATION:1}),Ve=function(e){Object(c.a)(i,e);var t=Object(d.a)(i);function i(e){var a;Object(l.a)(this,i),a=t.call(this,e);var n=xe.createInitialShape();return a.state={mode:Oe.EDIT,shape:n,activePlaceableId:0,historyEntries:[],historyIndex:-1},a.figures=null,a.figureRandomIndices=null,a.figureIndex=-1,a.addHistoryEntry(a.state,n,0),a}return Object(h.a)(i,[{key:"addHistoryEntry",value:function(e,t,i){var a=e.historyIndex+1,n=a>=30?a-30+1:0;a=Math.min(a,29),e.historyEntries=e.historyEntries.splice(n,a),e.historyEntries.push({shape:t,activePlaceableId:i}),e.historyIndex=e.historyEntries.length-1}},{key:"showFigure",value:function(e){var t=Fe.build(e,this.figures);t&&this.handleShapeChange(t,!0)}},{key:"handleShapeChange",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,a={shape:e,historyEntries:this.state.historyEntries,historyIndex:this.state.historyIndex};t||this.state.activePlaceableId&&!e.findPlaceable(this.state.activePlaceableId)?a.activePlaceableId=0:i&&(a.activePlaceableId=i),this.addHistoryEntry(a,e,a.activePlaceableId),this.setState(a)}},{key:"handleActivePlaceableChange",value:function(e){this.setState({activePlaceableId:e})}},{key:"handleHistoryChange",value:function(e){if(!(e<0||e>=this.state.historyEntries.length)){var t=this.state.historyEntries[e],i={shape:t.shape,activePlaceableId:t.activePlaceableId,historyIndex:e};this.setState(i)}}},{key:"handleShapeReset",value:function(){this.handleShapeChange(xe.createInitialShape(),!0)}},{key:"handleShapeShowcase",value:function(){var e=this;if(this.figures){this.figureIndex=(this.figureIndex+1)%this.figureRandomIndices.length;var t=this.figures.definitions[this.figureRandomIndices[this.figureIndex]].name;this.showFigure(t)}else fetch("res/figures.rsf").then((function(e){return e.json()})).then((function(t){e.figures=t,e.figureRandomIndices=Object(s.a)(Array(e.figures.definitions.length).keys()).map((function(e){return{sort:Math.random(),value:e}})).sort((function(e,t){return e.sort-t.sort})).map((function(e){return e.value})),e.figureIndex=-1,e.handleShapeShowcase()}))}},{key:"handleShapeImport",value:function(){var e=this,t=document.createElement("input");t.setAttribute("type","file"),t.setAttribute("accept",".twy"),t.addEventListener("change",(function(){if(t.files.length){var a=t.files[0],n=new FileReader;n.onload=function(t){var a=i.archiveToShape(t.target.result);a&&e.handleShapeChange(a,!0)},n.readAsText(a)}})),t.click()}},{key:"handleShapeExport",value:function(e){var t=prompt("Enter shape name: ");if(t){var a=document.createElement("a"),n=i.shapeToArchive(e),r=new Blob([n],{type:"text/plain;charset=utf-8"});a.href=URL.createObjectURL(r),a.download=t+".twy",document.body.appendChild(a),a.click()}}},{key:"handleSimulationStart",value:function(){this.setState({mode:Oe.SIMULATION})}},{key:"handleSimulationStop",value:function(){this.setState({mode:Oe.EDIT})}},{key:"render",value:function(){var e=this;return n.a.createElement("div",{className:"App"},n.a.createElement(Pe,{mode:this.state.mode,shape:this.state.shape,activePlaceableId:this.state.activePlaceableId,onShapeChange:function(t,i){return e.handleShapeChange(t,!1,i)},onActivePlaceableChange:function(t){return e.handleActivePlaceableChange(t)}}),n.a.createElement(Te,{mode:this.state.mode,shape:this.state.shape,activePlaceableId:this.state.activePlaceableId,historyEntries:this.state.historyEntries,historyIndex:this.state.historyIndex,onShapeChange:function(t){return e.handleShapeChange(t)},onHistoryChange:function(t){return e.handleHistoryChange(t)},onShapeReset:function(){return e.handleShapeReset()},onShapeShowcase:function(){return e.handleShapeShowcase()},onShapeImport:function(){return e.handleShapeImport()},onShapeExport:function(t){return e.handleShapeExport(t)},onSimulationStart:function(){return e.handleSimulationStart()},onSimulationStop:function(){return e.handleSimulationStop()}}))}}],[{key:"shapeToArchive",value:function(e){return JSON.stringify({version:2,shape:e.toArchive()})}},{key:"archiveToShape",value:function(e){var t=JSON.parse(e);if(!(t.version>2)){var i=new xe;return i.fromArchive(t.shape,t.version),i.applyTransform(),i}alert("Unsupported version: "+t.version)}}]),i}(a.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(n.a.createElement(n.a.StrictMode,null,n.a.createElement(Ve,null)),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},40:function(e,t,i){}},[[105,1,2]]]);
//# sourceMappingURL=main.0a21477d.chunk.js.map