(this.webpackJsonptwistyeditor=this.webpackJsonptwistyeditor||[]).push([[0],{207:function(e,t,i){"use strict";i.r(t);var n=i(0),a=i.n(n),r=i(81),o=i.n(r),s=(i(97),i(87)),l=i(5),c=i(19),h=i(6),d=i(7),u=i(10),f=i(9),p=(i(35),i(1)),v=function e(t,i){Object(h.a)(this,e),this.placeable=t,this.renderable=i},m=function(){function e(t,i,n){Object(h.a)(this,e),this.shape=t,this.placeableViews=new Map;var a,r=Object(l.a)(this.shape.prisms);try{for(r.s();!(a=r.n()).done;){var o=a.value;this.placeableViews.set(o.id,this.createPrismView(o,n))}}catch(u){r.e(u)}finally{r.f()}if(i){var s,c=Object(l.a)(this.shape.sections);try{for(c.s();!(s=c.n()).done;){var d=s.value;this.placeableViews.set(d.id,this.createSectionView(d,n))}}catch(u){c.e(u)}finally{c.f()}}this.syncTransform(n)}return Object(d.a)(e,[{key:"createPrismView",value:function(e,t){var i=t.createPrismRenderable(e);return new v(e,i)}},{key:"createSectionView",value:function(e,t){var i=t.createSectionRenderable(e);return new v(e,i)}},{key:"destroy",value:function(e){this.placeableViews.forEach((function(t){return e.destroyRenderable(t.renderable)})),this.placeableViews=null}},{key:"findPlaceableView",value:function(e){return this.placeableViews.get(e)}},{key:"addToScene",value:function(e){this.placeableViews.forEach((function(t){return e.scene.addEntity(t.renderable)}))}},{key:"removeFromScene",value:function(e){this.placeableViews.forEach((function(t){return e.scene.remove(t.renderable)}))}},{key:"syncTransform",value:function(e){this.placeableViews.forEach((function(t){return e.setRenderableTransform(t.renderable,t.placeable.worldPosition,t.placeable.worldOrientation)}))}}]),e}(),g=i(12),b=i.n(g),y=p.d.create(),k=p.d.create(),w=p.d.create(),P=p.d.create();function C(e,t,i,n){var a=p.d.sub(y,i,t),r=p.d.sub(k,n,t),o=p.d.cross(w,e.direction,r),s=p.d.dot(a,o);if(!(s<1e-6)){var l=p.d.sub(P,e.origin,t),c=p.d.dot(l,o);if(!(c<0||c>s)){var h=p.d.cross(P,l,a),d=p.d.dot(e.direction,h);if(!(d<0||c+d>s))return p.d.dot(r,h)/s}}}function j(e,t,i){var n=p.d.sub(y,e.origin,t),a=i*i,r=p.d.squaredLength(n);if(r<=a)return 0;var o=p.d.dot(e.direction,e.direction),s=2*p.d.dot(n,e.direction),l=s*s-4*o*(r-a);if(l>=0){var c=Math.sqrt(l),h=(-s-c)/(2*o);return h<0&&(h=(-s+c)/(2*o)),h}}function x(e,t){for(var i=0,n=0,a=0;a<t.length;a++){var r=p.d.dot(e,t[a]);0===a?(i=r,n=r):(r<i&&(i=r),r>n&&(n=r))}return{dmin:i,dmax:n}}function O(e,t,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.001;if(0===t.length||0===i.length)return!1;var a=x(e,t),r=x(e,i);return a.dmin+n<r.dmax&&r.dmin+n<a.dmax}function S(e,t){var i=p.d.sub(y,t,e.origin),n=p.d.scale(k,e.direction,p.d.dot(i,e.direction));return p.d.distance(i,n)}var I=i(88),M=i(17);function T(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:p.d.create(),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:p.c.create();return{position:e,orientation:t}}function F(e,t,i,n){var a=p.c.setAxisAngle(p.c.create(),i,n),r=p.d.sub(p.d.create(),e.position,t);p.d.transformQuat(r,r,a),p.d.add(r,r,t);var o=p.c.mul(a,a,e.orientation);return p.c.normalize(o,o),T(r,o)}function A(e,t,i){return p.d.transformQuat(e.position,i.position,t.orientation),p.d.add(e.position,e.position,t.position),p.c.mul(e.orientation,t.orientation,i.orientation),p.c.normalize(e.orientation,e.orientation),e}function R(e,t){return p.c.invert(e.orientation,t.orientation),p.d.negate(e.position,t.position),p.d.transformQuat(e.position,e.position,e.orientation),e}var V=function(){function e(){Object(h.a)(this,e),this.id=0,this.position=p.d.create(),this.orientation=p.c.create(),this.worldPosition=p.d.create(),this.worldOrientation=p.c.create()}return Object(d.a)(e,[{key:"applyTransform",value:function(e){p.d.transformQuat(this.worldPosition,this.position,e),p.c.multiply(this.worldOrientation,e,this.orientation)}},{key:"translate",value:function(e){p.d.add(this.position,this.position,e)}},{key:"rotate",value:function(e){p.d.transformQuat(this.position,this.position,e),p.c.multiply(this.orientation,e,this.orientation),p.c.normalize(this.orientation,this.orientation)}},{key:"copy",value:function(e){this.id=e.id,p.d.copy(this.position,e.position),p.c.copy(this.orientation,e.orientation),p.d.copy(this.worldPosition,e.worldPosition),p.c.copy(this.worldOrientation,e.worldOrientation)}}]),e}(),E=Object.freeze({LEFT:0,RIGHT:1,FRONT:2,BACK:3,BOTTOM:4}),L=.5,N=Math.sqrt(2),J=.5*N,G=[p.d.fromValues(-1,-.5,-J),p.d.fromValues(-1,-.5,J),p.d.fromValues(0,L,-J),p.d.fromValues(0,L,J),p.d.fromValues(1,-.5,-J),p.d.fromValues(1,-.5,J)],B=.04,D=B*Math.cos(Math.PI/4),H=[p.d.fromValues(2*D-1+B,-.46,-J+B),p.d.fromValues(2*D-1+B,-.46,J-B),p.d.fromValues(0,L-2*D,-J+B),p.d.fromValues(0,L-2*D,J-B),p.d.fromValues(1-2*D-B,-.46,-J+B),p.d.fromValues(1-2*D-B,-.46,J-B)],z=[0,1,2,2,1,3,2,3,4,4,3,5,4,5,0,0,5,1,0,2,4,5,3,1],Y=[[0,1,2,3],[2,3,5,4],[1,0,4,5],[0,2,4],[5,3,1]].map((function(e){var t=H[e[0]],i=H[e[1]],n=H[e[2]],a=p.d.sub(p.d.create(),i,t);return p.d.cross(a,a,p.d.sub(p.d.create(),n,t)),p.d.normalize(a,a)})),Z=p.d.fromValues(-.5,0,0),U=p.d.fromValues(.5,0,0),Q=-.5/6,K=p.d.rotateZ(p.d.create(),p.d.fromValues(0,1,0),p.d.fromValues(0,0,0),.25*Math.PI),q=p.d.rotateZ(p.d.create(),p.d.fromValues(0,1,0),p.d.fromValues(0,0,0),-.25*Math.PI),X=T(p.d.fromValues(-1,0,0),p.c.fromEuler(p.c.create(),-180,0,0)),W=T(p.d.fromValues(1,0,0),p.c.fromEuler(p.c.create(),180,0,0)),_=[{face:E.LEFT,swapColors:!0,pivot:Z,normal:K,tangent:q,transforms:[X,F(X,Z,K,.5*Math.PI),F(X,Z,K,Math.PI),F(X,Z,K,-.5*Math.PI)]},{face:E.RIGHT,swapColors:!0,pivot:U,normal:q,tangent:K,transforms:[W,F(W,U,q,-.5*Math.PI),F(W,U,q,Math.PI),F(W,U,q,.5*Math.PI)]},{face:E.FRONT,swapColors:!1,pivot:p.d.fromValues(0,Q,J),normal:p.d.fromValues(0,0,1),tangent:p.d.fromValues(0,1,0),transforms:[T(p.d.fromValues(0,0,N))]},{face:E.BACK,swapColors:!1,pivot:p.d.fromValues(0,Q,-J),normal:p.d.fromValues(0,0,-1),tangent:p.d.fromValues(0,1,0),transforms:[T(p.d.fromValues(0,0,-N))]},{face:E.BOTTOM,swapColors:!1,pivot:p.d.fromValues(0,-.5,0),normal:p.d.fromValues(0,-1,0),tangent:p.d.fromValues(0,0,-1),transforms:[T(p.d.fromValues(0,-1,0),p.c.fromEuler(p.c.create(),180,0,0))]}];function $(e,t){return p.d.squaredDistance(e,t)<.001}function ee(e,t,i,n,a,r,o,s){return $(e[i],t[r])&&$(e[n],t[o])&&$(e[a],t[s])}function te(e,t,i,n,a,r,o,s,l,c){return $(e[i],t[o])&&$(e[n],t[s])&&$(e[a],t[l])&&$(e[r],t[c])}function ie(e,t,i,n,a,r,o,s,l,c){return te(e,t,i,n,a,r,o,s,l,c)||te(e,t,i,n,a,r,s,l,c,o)||te(e,t,i,n,a,r,l,c,o,s)||te(e,t,i,n,a,r,c,o,s,l)}var ne=function(e){Object(u.a)(i,e);var t=Object(f.a)(i);function i(){var e;return Object(h.a)(this,i),(e=t.call(this)).colorMask=0,e.backgroundColor="#000",e.foregroundColor="#fff",e.vertices=G.map((function(e){return p.d.clone(e)})),e.collisionVertices=H.map((function(e){return p.d.clone(e)})),e.polygonNormals=Y.map((function(e){return p.d.clone(e)})),e}return Object(d.a)(i,[{key:"applyTransform",value:function(e){Object(I.a)(Object(M.a)(i.prototype),"applyTransform",this).call(this,e);for(var t=0;t<this.vertices.length;t++){var n=this.vertices[t];p.d.transformQuat(n,G[t],this.worldOrientation),p.d.add(n,n,this.worldPosition)}for(var a=0;a<this.collisionVertices.length;a++){var r=this.collisionVertices[a];p.d.transformQuat(r,H[a],this.worldOrientation),p.d.add(r,r,this.worldPosition)}for(var o=0;o<this.polygonNormals.length;o++)p.d.transformQuat(this.polygonNormals[o],Y[o],this.worldOrientation)}},{key:"intersect",value:function(e){return function(e,t,i){for(var n,a=0;a<i.length;a+=3){var r=C(e,t[i[a]],t[i[a+1]],t[i[a+2]]);void 0!==r&&(void 0===n||r<n)&&(n=r)}return n}(e,this.vertices,z)}},{key:"collides",value:function(e){return t=this.collisionVertices,i=this.polygonNormals,n=e.collisionVertices,a=e.polygonNormals,i.every((function(e){return O(e,t,n)}))&&a.every((function(e){return O(e,t,n)}));var t,i,n,a}},{key:"getJunctions",value:function(){for(var e=[],t=T(this.position,this.orientation),n=0;n<_.length;n++){for(var a=_[n],r=[],o=0;o<a.transforms.length;o++){var s=A(T(),t,a.transforms[o]),l=new i;l.colorMask=this.colorMask,l.backgroundColor=a.swapColors?this.foregroundColor:this.backgroundColor,l.foregroundColor=a.swapColors?this.backgroundColor:this.foregroundColor,p.d.copy(l.position,s.position),p.c.copy(l.orientation,s.orientation),r.push(l)}var c=p.d.transformQuat(p.d.create(),a.pivot,this.orientation);p.d.add(c,c,this.position);var h=p.d.transformQuat(p.d.create(),a.normal,this.orientation),d=p.d.transformQuat(p.d.create(),a.tangent,this.orientation);e.push({face:a.face,pivot:c,normal:h,tangent:d,prisms:r})}return e}},{key:"coincideFace",value:function(e,t){switch(t){case E.LEFT:if(ie(this.vertices,e.vertices,0,1,3,2,4,5,3,2))return E.RIGHT;if(ie(this.vertices,e.vertices,0,1,3,2,1,0,2,3))return E.LEFT;break;case E.RIGHT:if(ie(this.vertices,e.vertices,2,3,5,4,2,3,1,0))return E.LEFT;if(ie(this.vertices,e.vertices,2,3,5,4,3,2,4,5))return E.RIGHT;break;case E.FRONT:if(ee(this.vertices,e.vertices,1,3,5,0,2,4))return E.BACK;if(ee(this.vertices,e.vertices,1,3,5,5,3,1))return E.FRONT;break;case E.BACK:if(ee(this.vertices,e.vertices,0,2,4,1,3,5))return E.FRONT;if(ee(this.vertices,e.vertices,0,2,4,4,2,0))return E.BACK;break;case E.BOTTOM:if(te(this.vertices,e.vertices,0,1,5,4,4,5,1,0)||te(this.vertices,e.vertices,0,1,5,4,1,0,4,5))return E.BOTTOM}}},{key:"coincide",value:function(e){for(var t in E){var i=E[t],n=this.coincideFace(e,i);if(void 0!==n)return{baseFace:i,targetFace:n}}}},{key:"toArchive",value:function(){return{id:this.id,colorMask:this.colorMask,backgroundColor:this.backgroundColor,foregroundColor:this.foregroundColor,position:this.position,orientation:this.orientation}}},{key:"fromArchive",value:function(e){this.id=e.id,this.colorMask=e.colorMask,this.backgroundColor=e.backgroundColor,this.foregroundColor=e.foregroundColor,p.d.copy(this.position,e.position),p.c.copy(this.orientation,e.orientation)}},{key:"clone",value:function(){var e=new i;e.copy(this),e.colorMask=this.colorMask,e.backgroundColor=this.backgroundColor,e.foregroundColor=this.foregroundColor;for(var t=0;t<this.vertices.length;t++)p.d.copy(e.vertices[t],this.vertices[t]);for(var n=0;n<this.collisionVertices.length;n++)p.d.copy(e.collisionVertices[n],this.collisionVertices[n]);for(var a=0;a<this.polygonNormals.length;a++)p.d.copy(e.polygonNormals[a],this.polygonNormals[a]);return e}}]),i}(V),ae=Object.freeze({SEPARATOR:0,ACTUATOR:1}),re=p.c.setAxisAngle(p.c.create(),p.d.fromValues(0,1,0),Math.PI),oe=new Map([[ae.ACTUATOR,[{name:"initialAngle",min:-180,max:180,default:0},{name:"lowerAngle",min:-180,max:0,default:-90},{name:"upperAngle",min:0,max:180,default:90},{name:"power",min:0,max:1e4,default:1e3}]]]),se=function(e){Object(u.a)(i,e);var t=Object(f.a)(i);function i(){var e;return Object(h.a)(this,i),(e=t.call(this)).type=ae.ACTUATOR,e.baseFace=void 0,e.targetFace=void 0,e.basePrismId=0,e.targetPrismId=0,e.properties=new Map,e}return Object(d.a)(i,[{key:"swap",value:function(){var e=[this.targetFace,this.baseFace];this.baseFace=e[0],this.targetFace=e[1];var t=[this.targetPrismId,this.basePrismId];this.basePrismId=t[0],this.targetPrismId=t[1],p.c.multiply(this.orientation,this.orientation,re),p.c.normalize(this.orientation,this.orientation)}},{key:"intersect",value:function(e){var t=p.d.fromValues(1,0,0);return p.d.transformQuat(t,t,this.worldOrientation),function(e,t){var i=p.d.sub(y,e.direction,p.d.scale(y,t.normal,p.d.dot(e.direction,t.normal))),n=p.d.dot(i,i);if(!(n<1e-12)){var a=p.d.sub(k,e.origin,t.position),r=p.d.sub(w,a,p.d.scale(w,t.normal,p.d.dot(a,t.normal))),o=2*p.d.dot(i,r),s=o*o-4*n*(p.d.dot(r,r)-t.radius*t.radius);if(!(s<0)){var l=Math.sqrt(s),c=1/(2*n),h=c*(-o-l),d=c*(-o+l);if(!(h<0&&d<0)){var u=t.position,f=p.d.add(y,p.d.scale(y,t.normal,t.height),t.position),v=p.d.dot(t.normal,u),m=p.d.dot(t.normal,f);if(h>=0){var g=p.d.add(y,p.d.scale(y,e.direction,h),e.origin),b=p.d.dot(t.normal,g);if((v-b)*(m-b)<0)return h}if(d>=0){var P=p.d.add(y,p.d.scale(y,e.direction,d),e.origin),C=p.d.dot(t.normal,P);if((v-C)*(m-C)<0)return d}}}}}(e,function(e,t,i,n){var a=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=p.d.create();return a?(p.d.scale(r,t,-.5*n),p.d.add(r,r,e)):p.d.copy(r,e),{position:r,normal:p.d.clone(t),radius:i,height:n}}(this.worldPosition,t,1,.3,!0))}},{key:"getProperties",value:function(){var e=[],t=oe.get(this.type);if(t){var i,n=Object(l.a)(t);try{for(n.s();!(i=n.n()).done;){var a=i.value,r=void 0;r=this.properties.has(a.name)?this.properties.get(a.name):a.default;var o=Object.assign({},a);o.value=r,e.push(o)}}catch(s){n.e(s)}finally{n.f()}}return e}},{key:"getProperty",value:function(e){var t=oe.get(this.type);if(t)return t.find((function(t){return t.name===e}))}},{key:"getPropertyValue",value:function(e){if(this.properties.has(e))return this.properties.get(e);var t=this.getProperty(e);return t?t.default:void 0}},{key:"setPropertyValue",value:function(e,t){this.properties.set(e,this.validatePropertyValue(e,t))}},{key:"validatePropertyValue",value:function(e,t){var i=this.getProperty(e);return i?isNaN(t)?i.default:Math.max(i.min,Math.min(i.max,t)):t}},{key:"toArchive",value:function(){return{id:this.id,type:this.type,baseFace:this.baseFace,targetFace:this.targetFace,basePrismId:this.basePrismId,targetPrismId:this.targetPrismId,properties:Array.from(this.properties.entries()),position:this.position,orientation:this.orientation}}},{key:"fromArchive",value:function(e,t){this.id=e.id,t>=3?(this.type=e.type,this.properties=new Map(e.properties)):this.type=ae.SEPARATOR,this.baseFace=e.baseFace,this.targetFace=e.targetFace,this.basePrismId=e.basePrismId,this.targetPrismId=e.targetPrismId,p.d.copy(this.position,e.position),p.c.copy(this.orientation,e.orientation)}},{key:"clone",value:function(){var e=new i;return e.copy(this),e.type=this.type,e.baseFace=this.baseFace,e.targetFace=this.targetFace,e.basePrismId=this.basePrismId,e.targetPrismId=this.targetPrismId,e.properties=new Map(this.properties),e}}]),i}(V),le=Math.PI/180,ce=function(){function e(){Object(h.a)(this,e),this.name="",this.prisms=[],this.sections=[],this.lastPlaceableId=0,this.roll=0,this.pitch=0,this.yaw=0,this.showPose=!0,this.aabb={min:p.d.create(),max:p.d.create(),center:p.d.create()}}return Object(d.a)(e,[{key:"getOrientation",value:function(){var e=p.c.create();return p.c.rotateY(e,e,this.yaw*le),p.c.rotateX(e,e,this.roll*le),p.c.rotateZ(e,e,this.pitch*le),e}},{key:"applyTransform",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.getOrientation(),i=0;i<2;i++){p.d.zero(this.aabb.min),p.d.zero(this.aabb.max);for(var n=0;n<this.prisms.length;n++){var a=this.prisms[n];a.applyTransform(t);for(var r=0;r<a.vertices.length;r++){var o=a.vertices[r];0===n&&0===r?(p.d.copy(this.aabb.min,o),p.d.copy(this.aabb.max,o)):(p.d.min(this.aabb.min,this.aabb.min,o),p.d.max(this.aabb.max,this.aabb.max,o))}}if(0===i){var s=p.c.invert(p.c.create(),t),c=e?-.5*(this.aabb.min[0]+this.aabb.max[0]):0,h=e?-.5*(this.aabb.min[2]+this.aabb.max[2]):0,d=p.d.fromValues(c,-this.aabb.min[1],h);p.d.transformQuat(d,d,s),this.translate(d)}else{var u,f=Object(l.a)(this.sections);try{for(f.s();!(u=f.n()).done;){var v=u.value;v.applyTransform(t)}}catch(m){f.e(m)}finally{f.f()}p.d.add(this.aabb.center,this.aabb.min,this.aabb.max),p.d.scale(this.aabb.center,this.aabb.center,.5)}}}},{key:"translate",value:function(e){this.prisms.forEach((function(t){return t.translate(e)})),this.sections.forEach((function(t){return t.translate(e)}))}},{key:"rotate",value:function(e){this.prisms.forEach((function(t){return t.rotate(e)})),this.sections.forEach((function(t){return t.rotate(e)}))}},{key:"findPlaceable",value:function(e){if(!e)return null;var t,i=Object(l.a)(this.prisms);try{for(i.s();!(t=i.n()).done;){var n=t.value;if(n.id===e)return n}}catch(s){i.e(s)}finally{i.f()}var a,r=Object(l.a)(this.sections);try{for(r.s();!(a=r.n()).done;){var o=a.value;if(o.id===e)return o}}catch(s){r.e(s)}finally{r.f()}return null}},{key:"intersect",value:function(e){var t,i,n,a=Object(l.a)(this.prisms);try{for(a.s();!(n=a.n()).done;){var r=n.value,o=r.intersect(e);void 0!==o&&(void 0===i||o<i)&&(t=r,i=o)}}catch(u){a.e(u)}finally{a.f()}var s,c=Object(l.a)(this.sections);try{for(c.s();!(s=c.n()).done;){var h=s.value,d=h.intersect(e);void 0!==d&&(void 0===i||d<i)&&(t=h,i=d)}}catch(u){c.e(u)}finally{c.f()}if(t)return{hitPlaceable:t,hitDistance:i}}},{key:"hasPrismIntersections",value:function(){for(var e=0;e<this.prisms.length;e++)for(var t=this.prisms[e],i=e+1;i<this.prisms.length;i++){var n=this.prisms[i];if(t.collides(n))return!0}return!1}},{key:"getAvailableJunctions",value:function(e){var t=this,i=this.getOrientation(),n=e.getJunctions();return n.forEach((function(n){if(n.prisms.forEach((function(e){return e.applyTransform(i)})),n.prisms=n.prisms.filter((function(i){return t.prisms.every((function(t){return t===e||!t.collides(i)}))})),0===n.prisms.length){var a,r=Object(l.a)(t.prisms);try{var o=function(){var r=a.value;if(r===e)return"continue";var o=e.coincideFace(r,n.face);if(void 0!==o){if(t.sections.some((function(t){return t.basePrismId===e.id&&t.targetPrismId===r.id||t.basePrismId===r.id&&t.targetPrismId===e.id})))return"continue";var s=new se,l=p.d.cross(p.d.create(),n.normal,n.tangent);return p.d.copy(s.position,n.pivot),p.c.fromMat3(s.orientation,p.a.fromValues(n.normal[0],n.normal[1],n.normal[2],n.tangent[0],n.tangent[1],n.tangent[2],l[0],l[1],l[2])),s.baseFace=n.face,s.targetFace=o,s.basePrismId=e.id,s.targetPrismId=r.id,s.applyTransform(i),n.section=s,"break"}};for(r.s();!(a=r.n()).done;){var s=o();if("continue"!==s&&"break"===s)break}}catch(c){r.e(c)}finally{r.f()}}p.d.transformQuat(n.pivot,n.pivot,i),p.d.transformQuat(n.normal,n.normal,i),p.d.transformQuat(n.tangent,n.tangent,i)})),n.filter((function(e){return e.prisms.length>0||e.section}))}},{key:"discoverParts",value:function(){var e,t=this,i=[],n=Object(l.a)(this.prisms);try{var a=function(){var n,a=e.value,r=[],o=Object(l.a)(i);try{for(o.s();!(n=o.n()).done;){var s,c=n.value,h=Object(l.a)(c);try{var d=function(){var e=s.value,i=a.coincide(e);if(void 0!==i&&t.sections.every((function(e){return(e.basePrismId!==a.id||e.baseFace!==i.baseFace)&&(e.targetPrismId!==a.id||e.targetFace!==i.baseFace)})))return r.push(c),"break"};for(h.s();!(s=h.n()).done;){if("break"===d())break}}catch(f){h.e(f)}finally{h.f()}}}catch(f){o.e(f)}finally{o.f()}var u=void 0;1===r.length?u=r[0]:r.length>1?(u=[].concat.apply([],r),(i=i.filter((function(e){return!r.includes(e)}))).push(u)):(u=[],i.push(u)),u.push(a)};for(n.s();!(e=n.n()).done;)a()}catch(r){n.e(r)}finally{n.f()}return i}},{key:"discoverPartChains",value:function(e){for(var t=[],i=new Set(e);i.size>0;){var n=i.values().next().value,a=this.findChildParts(null,n,null,e,!1);if(!a)return;var r,o=Object(l.a)(a);try{for(o.s();!(r=o.n()).done;){var s=r.value;i.delete(s)}}catch(f){o.e(f)}finally{o.f()}t.push(a)}t.sort((function(e,t){return e.length===t.length?t.reduce((function(e,t){return e+t.length}))-e.reduce((function(e,t){return e+t.length})):t.length-e.length}));for(var c=0;c<t.length;c++)for(var h=t[c],d=function(e){var i=t[e];h.some((function(e){return i.some((function(t){return t===e}))}))&&(t.splice(e,1),e--),u=e},u=c+1;u<t.length;u++)d(u);return t}},{key:"findValidSectionRefs",value:function(e,t){var i=this.findPlaceable(e.basePrismId),n=this.findPlaceable(e.targetPrismId),a=t.find((function(e){return e.some((function(e){return e===i}))})),r=t.find((function(e){return e.some((function(e){return e===n}))}));return a&&r||console.log("Section parts not found"),a===r&&console.log("Section must connect different parts"),{basePart:a,targetPart:r}}},{key:"findChildParts",value:function(e,t,i,n,a){var r=this,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:[];0===o.length&&o.push(t);var s,c=Object(l.a)(this.sections);try{var h=function(){var l=s.value;if(l.type===ae.SEPARATOR||l===i)return"continue";var c=r.findValidSectionRefs(l,n);if(!c)return{v:void 0};var h=c.basePart===t?c.targetPart:null;return!h&&a&&(h=c.targetPart===t?c.basePart:null),h?h===e||o.find((function(e){return e===h}))?(console.log("Child parts must not be looped"),{v:void 0}):(o.push(h),r.findChildParts(e,h,l,n,a,o)?void 0:{v:void 0}):"continue"};for(c.s();!(s=c.n()).done;){var d=h();if("continue"!==d&&"object"===typeof d)return d.v}}catch(u){c.e(u)}finally{c.f()}return o}},{key:"applyInitialAngles",value:function(){var e,t,i=this,n=p.d.create(),a=p.d.create(),r=p.c.create(),o=Object(l.a)(this.sections);try{var s=function(){var o=t.value;if(o.type!==ae.ACTUATOR)return"continue";var s=o.getPropertyValue("initialAngle");if(0===s)return"continue";e||(e=i.discoverParts());var l=i.findValidSectionRefs(o,e);if(!l)return{v:void 0};var h=i.findChildParts(l.basePart,l.targetPart,o,e,!0);if(!h)return console.log("Failed to apply initial angle"),"continue";p.d.negate(n,o.position),p.d.transformQuat(a,p.d.set(a,1,0,0),o.orientation),p.c.setAxisAngle(r,a,s*le);var d=h.flat(),u=i.sections.filter((function(e){return d.some((function(t){return t.id===e.basePrismId||t.id===e.targetPrismId}))}));[].concat(Object(c.a)(d),Object(c.a)(u)).forEach((function(e){e!==o&&(e.translate(n),e.rotate(r),e.translate(o.position))}))};for(o.s();!(t=o.n()).done;){var h=s();if("continue"!==h&&"object"===typeof h)return h.v}}catch(d){o.e(d)}finally{o.f()}e&&this.applyTransform()}},{key:"toArchive",value:function(){return{name:this.name,prisms:this.prisms.map((function(e){return e.toArchive()})),sections:this.sections.map((function(e){return e.toArchive()})),lastPlaceableId:this.lastPlaceableId,roll:this.roll,pitch:this.pitch,yaw:this.yaw,showPose:this.showPose}}},{key:"fromArchive",value:function(e,t){this.prisms=e.prisms.map((function(e){var t=new ne;return t.fromArchive(e),t})),t>=2?(this.sections=e.sections.map((function(e){var i=new se;return i.fromArchive(e,t),i})),this.lastPlaceableId=e.lastPlaceableId):this.lastPlaceableId=e.lastPrismId,this.roll=e.roll,this.pitch=e.pitch,this.yaw=e.yaw,t>=3&&(this.name=e.name,this.showPose=e.showPose)}},{key:"clone",value:function(){var t=new e;t.name=this.name;var i,n=Object(l.a)(this.prisms);try{for(n.s();!(i=n.n()).done;){var a=i.value;t.prisms.push(a.clone())}}catch(c){n.e(c)}finally{n.f()}var r,o=Object(l.a)(this.sections);try{for(o.s();!(r=o.n()).done;){var s=r.value;t.sections.push(s.clone())}}catch(c){o.e(c)}finally{o.f()}return t.lastPlaceableId=this.lastPlaceableId,t.roll=this.roll,t.pitch=this.pitch,t.yaw=this.yaw,t.showPose=this.showPose,p.d.copy(t.aabb.min,this.aabb.min),p.d.copy(t.aabb.max,this.aabb.max),p.d.copy(t.aabb.center,this.aabb.center),t}}],[{key:"createInitialShape",value:function(){var t=new e,i=new ne;return i.id=++t.lastPlaceableId,i.backgroundColor="#1976d2",i.foregroundColor="#d9d9d9",t.prisms.push(i),t.applyTransform(),t}}]),e}(),he=i(4),de=Math.PI/180,ue=180/Math.PI,fe=.48*Math.PI,pe=-Math.PI/10,ve=-Math.PI/40;var me="#e6e6e6ff",ge="#ffff40",be="#b266ff",ye=new Map([[ae.SEPARATOR,"#4caf50"],[ae.ACTUATOR,"#ff9800"]]),ke="#90caf960",we="#fff59d60",Pe="res/environment_ibl.ktx",Ce="res/prism.filamesh",je="res/prism.filamat",xe="res/ghost.filamat",Oe="res/highcol.filamat",Se="res/knob.filamesh",Ie="res/ground.filamat",Me="res/ground.png",Te="res/section.filamesh",Fe=function(e){return"res/prism"+e+".png"},Ae=function(e){var t=b()(e).toRgb();return[t.r/255,t.g/255,t.b/255]},Re=function(e){var t=b()(e).toRgb();return[t.r/255,t.g/255,t.b/255,t.a]},Ve=function(e){Object(u.a)(i,e);var t=Object(f.a)(i);function i(e){var n;return Object(h.a)(this,i),(n=t.call(this,e)).auxMat4=p.b.create(),n.auxTransform=T(),n}return Object(d.a)(i,[{key:"componentDidMount",value:function(){for(var e=this,t=[Pe,Ce,je,xe,Oe,Se,Ie,Me,Te],i=0;i<8;i++)t.push(Fe(i));window.Filament.init(t,(function(){e.init()}))}},{key:"componentDidUpdate",value:function(e){var t=e.mode!==this.props.mode,i=e.originalShape!==this.props.originalShape,n=e.trainingState!==this.props.trainingState;(t||i)&&this.refreshShapeView(),this.prepareGoalView(),n&&(this.updateShapeView(this.props.trainingState.transforms),this.updateGoalView(this.props.trainingState.goalPosition))}},{key:"refreshShapeView",value:function(){if(this.engine){this.shapeView&&this.shapeView.destroy(this);var e=this.props.mode===st.EDIT;this.shapeView=new m(this.props.finalShape,e,this),this.shapeView.addToScene(this),this.activePlaceableView=null;var t=this.props.mode===st.EDIT?this.props.finalShape.findPlaceable(this.props.activePlaceableId):null;this.selectPlaceable(t,!0,!1)}}},{key:"prepareGoalView",value:function(){if(this.engine){if(!this.goalShape){var e=JSON.parse('{"version":3,"shape":{"name":"Goal","prisms":[{"id":1,"colorMask":3,"backgroundColor":"#d32f2f","foregroundColor":"#d9d9d9","position":{"0":0,"1":0.5,"2":-1.5739213228225708},"orientation":{"0":0,"1":0,"2":0,"3":1}},{"id":2,"colorMask":3,"backgroundColor":"#d9d9d9","foregroundColor":"#d32f2f","position":{"0":1,"1":0.5,"2":-1.5739213228225708},"orientation":{"0":1,"1":0,"2":0,"3":6.123234262925839e-17}},{"id":3,"colorMask":3,"backgroundColor":"#d32f2f","foregroundColor":"#d9d9d9","position":{"0":2,"1":0.5,"2":-1.5739213228225708},"orientation":{"0":1.2246468525851679e-16,"1":0,"2":0,"3":-1}},{"id":4,"colorMask":3,"backgroundColor":"#d9d9d9","foregroundColor":"#d32f2f","position":{"0":1,"1":1.5,"2":-1.5739213228225708},"orientation":{"0":1.2246468525851679e-16,"1":0,"2":0,"3":-1}},{"id":5,"colorMask":3,"backgroundColor":"#d32f2f","foregroundColor":"#d9d9d9","position":{"0":0.5,"1":2,"2":-1.5739213228225708},"orientation":{"0":1.7934537957764396e-17,"1":-1.2989341566884322e-16,"2":-0.7071067690849304,"3":0.7071067690849304}},{"id":6,"colorMask":3,"backgroundColor":"#d32f2f","foregroundColor":"#d9d9d9","position":{"0":1.5,"1":2,"2":-1.5739213228225708},"orientation":{"0":-1.911257582981016e-16,"1":4.329780632585522e-17,"2":0.7071067690849304,"3":0.7071067690849304}},{"id":7,"colorMask":3,"backgroundColor":"#d9d9d9","foregroundColor":"#d32f2f","position":{"0":1.5,"1":3,"2":-1.5739213228225708},"orientation":{"0":0.7071067690849304,"1":0.7071067690849304,"2":-2.3657788664006152e-24,"3":2.344235679326793e-16}},{"id":8,"colorMask":3,"backgroundColor":"#d9d9d9","foregroundColor":"#d32f2f","position":{"0":0.5000000596046448,"1":3,"2":-1.5739213228225708},"orientation":{"0":2.7772137756725695e-16,"1":4.329780301713277e-17,"2":-0.7071067690849304,"3":-0.7071067690849304}},{"id":9,"colorMask":3,"backgroundColor":"#d32f2f","foregroundColor":"#d9d9d9","position":{"0":0.5000001192092896,"1":4,"2":-1.5739213228225708},"orientation":{"0":-0.7071067690849304,"1":-0.7071067690849304,"2":-8.659560603426554e-17,"3":-3.210191872018346e-16}},{"id":10,"colorMask":3,"backgroundColor":"#d32f2f","foregroundColor":"#d9d9d9","position":{"0":1.5,"1":4,"2":-1.5739213228225708},"orientation":{"0":2.7772137756725695e-16,"1":4.329780301713277e-17,"2":-0.7071067690849304,"3":-0.7071067690849304}},{"id":11,"colorMask":3,"backgroundColor":"#d9d9d9","foregroundColor":"#d32f2f","position":{"0":1,"1":4.5,"2":-1.5739213228225708},"orientation":{"0":-2.702926603918203e-16,"1":6.12323624815931e-17,"2":1,"3":0}},{"id":12,"colorMask":3,"backgroundColor":"#d9d9d9","foregroundColor":"#d32f2f","position":{"0":1,"1":5.5,"2":-1.5739213228225708},"orientation":{"0":-1.6550653361678656e-32,"1":1,"2":-1.9852334701272664e-23,"3":2.702926603918203e-16}}],"sections":[],"lastPlaceableId":12,"roll":0,"pitch":0,"yaw":0,"showPose":true}}');this.goalShape=new ce,this.goalShape.fromArchive(e.shape,e.version),this.goalShape.applyTransform(!0)}this.goalView?this.goalPosition&&this.goalView.removeFromScene(this):this.props.mode!==st.EDIT&&(this.goalView=new m(this.goalShape,!1,this)),this.goalPosition=null}}},{key:"init",value:function(){var e=this;this.elevation=pe,this.heading=ve,this.focalLengthMin=15,this.focalLengthMax=50,this.cameraZoom=1,this.targetZoom=this.cameraZoom,this.lastZoom=this.cameraZoom,this.focalPoint=p.d.create(),this.targetPosition=p.d.create(),this.lastPosition=p.d.create(),this.highlightColor=[0,0,0,0],this.animationTimer=0,this.highlightTimer=0,this.shapeView=null,this.activePlaceableView=null,this.availableJunctions=null,this.originalAvailableJunctions=null,this.goalPosition=null,this.goalShape=null,this.goalView=null,this.pressing=!1,this.dragging=!1,this.pickedPlaceable=null,this.pickedJunction=null,this.activeJunctionPrism=null,this.pointerX=0,this.pointerY=0,this.canvas=this.filament;var t=this.engine=window.Filament.Engine.create(this.canvas);this.camera=t.createCamera(window.Filament.EntityManager.get().create()),this.scene=t.createScene();var i=window.Filament.EntityManager.get().create();window.Filament.LightManager.Builder(window.Filament.LightManager$Type.SUN).color([.98,.92,.89]).intensity(7e4).direction([.6,-1,-.8]).sunAngularRadius(1.9).sunHaloSize(10).sunHaloFalloff(80).castShadows(!0).build(t,i),this.scene.addEntity(i);var n=t.createIblFromKtx(Pe);n.setIntensity(4e4),this.scene.setIndirectLight(n),this.prismMaterial=t.createMaterial(je),this.prismMesh=t.loadFilamesh(Ce),this.ghostMaterial=t.createMaterial(xe),this.ghostRenderable=this.createRenderable(this.createGhostMaterial(),this.prismMesh),this.highcolMaterial=t.createMaterial(Oe),this.knobMesh=t.loadFilamesh(Se),this.knobRenderables=[],this.sectionMesh=t.loadFilamesh(Te),this.sectionRenderables=[],this.prismTextures=[];for(var a=0;a<8;a++)this.prismTextures.push(t.createTextureFromPng(Fe(a)));this.prismTextureSampler=new window.Filament.TextureSampler(window.Filament.MinFilter.LINEAR_MIPMAP_LINEAR,window.Filament.MagFilter.LINEAR,window.Filament.WrapMode.CLAMP_TO_EDGE);var r=this.createGround(1e3,4);this.scene.addEntity(r),this.refreshShapeView(),this.swapChain=t.createSwapChain(),this.renderer=t.createRenderer(),this.view=t.createView(),this.view.setCamera(this.camera),this.view.setScene(this.scene),this.view.setFogOptions({color:Ae(me),distance:30,enabled:!0}),this.renderer.setClearOptions({clearColor:Re(me),clear:!0}),this.resize(),this.renderFrame=this.renderFrame.bind(this),this.resize=this.resize.bind(this),window.addEventListener("resize",this.resize),window.requestAnimationFrame(this.renderFrame),this.canvas.addEventListener("pointerdown",(function(t){return e.handlePointerDown(t)})),this.canvas.addEventListener("pointerup",(function(t){return e.handlePointerUp(t)})),this.canvas.addEventListener("pointermove",(function(t){return e.handlePointerMove(t)}))}},{key:"createGround",value:function(e,t){var i=window.Filament.VertexBuffer.Builder().vertexCount(4).bufferCount(2).attribute(window.Filament.VertexAttribute.POSITION,0,window.Filament.VertexBuffer$AttributeType.FLOAT3,0,12).attribute(window.Filament.VertexAttribute.UV0,1,window.Filament.VertexBuffer$AttributeType.FLOAT2,0,8).build(this.engine);i.setBufferAt(this.engine,0,new Float32Array([-e,0,-e,-e,0,e,e,0,-e,e,0,e]));var n=2*e/t;i.setBufferAt(this.engine,1,new Float32Array([0,0,0,n,n,0,n,n]));var a=window.Filament.IndexBuffer.Builder().indexCount(6).bufferType(window.Filament.IndexBuffer$IndexType.USHORT).build(this.engine);a.setBuffer(this.engine,new Uint16Array([0,1,2,2,1,3]));var r=this.engine.createMaterial(Ie),o=this.engine.createTextureFromPng(Me),s=new window.Filament.TextureSampler(window.Filament.MinFilter.LINEAR_MIPMAP_LINEAR,window.Filament.MagFilter.LINEAR,window.Filament.WrapMode.REPEAT),l=r.getDefaultInstance();l.setTextureParameter("baseColor",o,s);var c=window.Filament.EntityManager.get().create();return window.Filament.RenderableManager.Builder(1).boundingBox({center:[0,0,0],halfExtent:[e,0,e]}).material(0,l).geometry(0,window.Filament.RenderableManager$PrimitiveType.TRIANGLES,i,a).castShadows(!1).receiveShadows(!0).build(this.engine,c),c}},{key:"createRenderable",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=window.Filament.EntityManager.get().create();return window.Filament.RenderableManager.Builder(1).boundingBox(this.getBoundingBox(t.renderable)).material(0,e).geometry(0,window.Filament.RenderableManager$PrimitiveType.TRIANGLES,t.vertexBuffer,t.indexBuffer).castShadows(i).receiveShadows(n).build(this.engine,a),a}},{key:"destroyRenderable",value:function(e){var t=this.getRenderableMaterial(e);this.engine.destroyMaterialInstance(t),this.engine.destroyEntity(e),this.engine.getRenderableManager().destroy(e)}},{key:"createGhostMaterial",value:function(){var e=this.ghostMaterial.createInstance();return e.setColor4Parameter("baseColor",window.Filament.RgbaType.sRGB,Re(ke)),e}},{key:"createHighcolMaterial",value:function(e){var t=this.highcolMaterial.createInstance();return t.setColor3Parameter("baseColor",window.Filament.RgbaType.sRGB,Ae(e)),t.setColor4Parameter("highlightColor",window.Filament.RgbaType.sRGB,[0,0,0,0]),t}},{key:"createPrismRenderable",value:function(e){var t=e.colorMask>=0&&e.colorMask<8?e.colorMask:0,i=this.prismMaterial.createInstance();return i.setTextureParameter("colorMask",this.prismTextures[t],this.prismTextureSampler),i.setColor3Parameter("backgroundColor",window.Filament.RgbType.sRGB,Ae(e.backgroundColor)),i.setColor3Parameter("foregroundColor",window.Filament.RgbType.sRGB,Ae(e.foregroundColor)),i.setColor4Parameter("highlightColor",window.Filament.RgbaType.sRGB,[0,0,0,0]),this.createRenderable(i,this.prismMesh,!0,!0)}},{key:"createGhostKnobRenderable",value:function(){return this.createRenderable(this.createGhostMaterial(),this.knobMesh)}},{key:"createGhostSectionRenderable",value:function(){return this.createRenderable(this.createGhostMaterial(),this.sectionMesh)}},{key:"createSectionRenderable",value:function(e){return this.createRenderable(this.createHighcolMaterial(ye.get(e.type)),this.sectionMesh)}},{key:"getBoundingBox",value:function(e){var t=this.engine.getRenderableManager(),i=t.getInstance(e),n=t.getAxisAlignedBoundingBox(i);return i.delete(),n}},{key:"setRenderableTransform",value:function(e,t,i){var n=this.engine.getTransformManager(),a=n.getInstance(e),r=p.b.fromRotationTranslation(this.auxMat4,i,t);n.setTransform(a,r),a.delete()}},{key:"getRenderableMaterial",value:function(e){var t=this.engine.getRenderableManager(),i=t.getInstance(e),n=t.getMaterialInstanceAt(i,0);return i.delete(),n}},{key:"updateCamera",value:function(){var e=[this.focalPoint[0],this.focalPoint[1],this.focalPoint[2]+10];p.d.rotateX(e,e,this.focalPoint,this.elevation),p.d.rotateY(e,e,this.focalPoint,this.heading),this.camera.lookAt(e,this.focalPoint,[0,1,0]);var t,i=this.focalLengthMin*(1-this.cameraZoom)+this.focalLengthMax*this.cameraZoom,n=(t=i,2*Math.atan(16/t)*ue),a=this.canvas.width/this.canvas.height;this.camera.setProjectionFov(n,a,1,300,window.Filament.Camera$Fov.VERTICAL)}},{key:"updateFollowPosition",value:function(e){p.d.copy(this.lastPosition,this.focalPoint),p.d.copy(this.targetPosition,e),this.lastZoom=this.cameraZoom,this.animationTimer=.075}},{key:"updateShapeView",value:function(e){for(var t=this.props.rigidInfo.baseLinks.length>0?this.props.rigidInfo.baseLinks[0]:null,i=0;i<e.length;i++){var n=e[i],a=this.props.rigidInfo.links[i];a===t&&this.updateFollowPosition(n.position);for(var r=0;r<a.prisms.length;r++){var o=a.prisms[r].id,s=a.viewTransforms[r];A(this.auxTransform,n,s);var l=this.shapeView.findPlaceableView(o);this.setRenderableTransform(l.renderable,this.auxTransform.position,this.auxTransform.orientation)}}}},{key:"updateGoalView",value:function(e){var t=this;this.goalPosition||this.goalView.addToScene(this),this.goalPosition&&p.d.equals(this.goalPosition,e)||(this.goalView.placeableViews.forEach((function(i){p.c.copy(t.auxTransform.orientation,i.placeable.worldOrientation),p.d.add(t.auxTransform.position,i.placeable.worldPosition,e),t.setRenderableTransform(i.renderable,t.auxTransform.position,t.auxTransform.orientation)})),this.goalPosition=e)}},{key:"renderFrame",value:function(e){void 0===this.lastTime&&(this.lastTime=e);var t=.001*(e-this.lastTime);if(this.lastTime=e,this.animationTimer<.3){this.animationTimer+=t;var i=Math.min(this.animationTimer/.3,1),n=i*i*(3-2*i);p.d.lerp(this.focalPoint,this.lastPosition,this.targetPosition,n),this.cameraZoom=this.lastZoom*(1-n)+this.targetZoom*n,this.updateCamera()}if(this.activePlaceableView){this.highlightTimer+=t,this.highlightTimer>2&&(this.highlightTimer%=2);var a=2*Math.abs(this.highlightTimer/2-.5),r=.3+.5*(a*a*(3-2*a));this.setHighlightIntensity(this.activePlaceableView,r)}this.renderer.render(this.swapChain,this.view),window.requestAnimationFrame(this.renderFrame)}},{key:"resize",value:function(){var e=window.devicePixelRatio,t=this.canvas.width=.8*window.innerWidth*e,i=this.canvas.height=window.innerHeight*e;if(this.view.setViewport([0,0,t,i]),this.focalLengthMin=15,this.focalLengthMax=50,t<i){var n=t/i;this.focalLengthMin*=n,this.focalLengthMax*=n}this.updateCamera()}},{key:"isPrimaryPointer",value:function(e){return"touch"!==e.pointerType||e.isPrimary}},{key:"handlePointerDown",value:function(e){if(this.isPrimaryPointer(e)){if(this.pickedPlaceable=null,this.pickedJunction=null,this.activeJunctionPrism=null,this.props.mode===st.EDIT){var t,i=this.getCastingRay(e.clientX,e.clientY),n=this.props.finalShape.intersect(i);this.props.activePlaceableId&&(t=this.intersectJunctions(i)),t&&(!n||t.hitDistance<n.hitDistance)?(this.pickedJunction=t.hitJunction,this.pickedJunction.section?this.activatePrismSection(this.availableJunctions,this.pickedJunction):this.activatePrismKnob(this.availableJunctions,this.pickedJunction)):this.pickedPlaceable=n?n.hitPlaceable:null}this.pressing=!0,this.dragging=!1,this.pointerX=e.clientX,this.pointerY=e.clientY}}},{key:"handlePointerUp",value:function(e){var t=this;if(this.isPrimaryPointer(e)){if(this.props.mode===st.EDIT){if(this.pickedJunction){if(this.pickedJunction.section||this.activeJunctionPrism){var i=this.availableJunctions.indexOf(this.pickedJunction),n=this.originalAvailableJunctions[i];if(n.section)this.addSection(n.section);else{var a=this.pickedJunction.prisms.findIndex((function(e){return e===t.activeJunctionPrism})),r=n.prisms[a];this.addPrism(r)}}}else this.dragging||this.selectPlaceable(this.pickedPlaceable,!0,!0);this.hideGhostPrism(),this.availableJunctions&&(this.showPrismKnobs(this.availableJunctions),this.showPrismSections(this.availableJunctions))}this.pressing=!1}}},{key:"handlePointerMove",value:function(e){if(this.isPrimaryPointer(e)&&this.pressing){var t=e.clientX-this.pointerX,i=e.clientY-this.pointerY;if(this.dragging)if(this.pickedJunction&&!this.pickedJunction.section){var n=this.getCastingRay(e.clientX,e.clientY),a=this.pickNearestJunctionPrism(n,this.pickedJunction);a!==this.activeJunctionPrism&&(this.showGhostPrism(a.worldPosition,a.worldOrientation),this.activeJunctionPrism=a)}else this.pickedJunction||(this.elevation=Math.min(Math.max(this.elevation-.01*i,-fe),fe),this.heading=(this.heading-.01*t)%(2*Math.PI),this.updateCamera(),this.pointerX=e.clientX,this.pointerY=e.clientY);else t*t+i*i>=9&&(this.pointerX=e.clientX,this.pointerY=e.clientY,this.dragging=!0)}}},{key:"computeAutoZoom",value:function(e){var t,i,n=0,a=p.d.create(),r=p.a.fromMat4(p.a.create(),this.camera.getViewMatrix()),o=this.canvas.height/this.canvas.width,s=Object(l.a)(e.prisms);try{for(s.s();!(t=s.n()).done;){var c,h=t.value,d=Object(l.a)(h.vertices);try{for(d.s();!(c=d.n()).done;){var u=c.value;p.d.sub(a,u,e.aabb.center),p.d.transformMat3(a,a,r);var f=2*Math.atan(1.1*o*Math.abs(a[0])/(10-a[2]))*ue;f>n&&(n=f);var v=2*Math.atan(1.1*Math.abs(a[1])/(10-a[2]))*ue;v>n&&(n=v)}}catch(g){d.e(g)}finally{d.f()}}}catch(g){s.e(g)}finally{s.f()}if(n>0){var m=((i=n,16/Math.tan(.5*i*de))-this.focalLengthMin)/(this.focalLengthMax-this.focalLengthMin);return Math.min(Math.max(m,0),1)}return 1}},{key:"getCastingRay",value:function(e,t){var i=window.devicePixelRatio,n=2*e*i/this.canvas.width-1,a=1-2*t*i/this.canvas.height,r=p.e.fromValues(n,a,-1,1);p.e.transformMat4(r,r,window.Filament.Camera.inverseProjection(this.camera.getProjectionMatrix())),r[2]=-1,r[3]=0,p.e.transformMat4(r,r,this.camera.getModelMatrix());var o=p.d.fromValues(r[0],r[1],r[2]);return p.d.normalize(o,o),{origin:this.camera.getPosition(),direction:o}}},{key:"intersectJunctions",value:function(e){if(this.availableJunctions){for(var t,i,n=0;n<this.availableJunctions.length;n++){var a=this.availableJunctions[n],r=void 0;void 0!==(r=a.section?a.section.intersect(e):j(e,a.pivot,.4))&&(void 0===i||r<i)&&(t=a,i=r)}if(t)return{hitJunction:t,hitDistance:i}}}},{key:"pickNearestJunctionPrism",value:function(e,t){for(var i,n=null,a=0;a<t.prisms.length;a++){var r=t.prisms[a],o=S(e,r.worldPosition);(void 0===i||o<i)&&(n=r,i=o)}return n}},{key:"selectPlaceable",value:function(e,t,i){if(this.activePlaceableView&&this.setHighlightIntensity(this.activePlaceableView,0),this.activePlaceableView=e?this.shapeView.findPlaceableView(e.id):null,this.activePlaceableView&&this.updateHighlightColor(e),e instanceof ne&&this.activePlaceableView){var n=this.props.originalShape.findPlaceable(e.id);this.availableJunctions=this.props.finalShape.getAvailableJunctions(e),this.originalAvailableJunctions=this.props.originalShape.getAvailableJunctions(n),this.showPrismKnobs(this.availableJunctions),this.showPrismSections(this.availableJunctions)}else this.availableJunctions=null,this.originalAvailableJunctions=null,this.hidePrismKnobs(),this.hidePrismSections();t&&(p.d.copy(this.lastPosition,this.targetPosition),this.lastZoom=this.targetZoom,this.activePlaceableView?(p.d.copy(this.targetPosition,e.worldPosition),this.targetZoom=1):(p.d.copy(this.targetPosition,this.props.finalShape.aabb.center),this.targetZoom=this.computeAutoZoom(this.props.finalShape)),this.animationTimer=0,this.highlightTimer=0),i&&this.props.onActivePlaceableChange(e?e.id:0)}},{key:"addPrism",value:function(e){var t=this.props.originalShape.clone();e.id=++t.lastPlaceableId,t.prisms.push(e),t.applyTransform(),this.props.onShapeChange(t,e.id)}},{key:"addSection",value:function(e){var t=this.props.originalShape.clone();e.id=++t.lastPlaceableId,t.sections.push(e),t.applyTransform(),this.props.onShapeChange(t,e.id)}},{key:"updateHighlightColor",value:function(e){var t;if(e instanceof ne?t=e.backgroundColor:e instanceof se&&(t=ye.get(e.type)),t){var i=b.a.readability(t,ge)>b.a.readability(t,be)?ge:be,n=b()(i).toRgb();this.highlightColor[0]=n.r/255,this.highlightColor[1]=n.g/255,this.highlightColor[2]=n.b/255}}},{key:"setHighlightIntensity",value:function(e,t){var i=this.getRenderableMaterial(e.renderable);this.highlightColor[3]=t,i.setColor4Parameter("highlightColor",window.Filament.RgbaType.sRGB,this.highlightColor)}},{key:"setGhostColor",value:function(e,t){this.getRenderableMaterial(e).setColor4Parameter("baseColor",window.Filament.RgbaType.sRGB,Re(t))}},{key:"showGhostPrism",value:function(e,t){this.setRenderableTransform(this.ghostRenderable,e,t),this.scene.addEntity(this.ghostRenderable)}},{key:"hideGhostPrism",value:function(){this.scene.remove(this.ghostRenderable)}},{key:"showPrismKnobs",value:function(e){for(;this.knobRenderables.length<e.length;)this.knobRenderables.push(this.createGhostKnobRenderable());for(var t=0;t<e.length;t++){var i=e[t],n=this.knobRenderables[t];this.setGhostColor(n,ke),this.setRenderableTransform(n,i.pivot,p.c.create()),this.scene.addEntity(n)}for(var a=e.length;a<this.knobRenderables.length;a++)this.scene.remove(this.knobRenderables[a])}},{key:"activatePrismKnob",value:function(e,t){var i=e.indexOf(t),n=this.knobRenderables[i];this.setGhostColor(n,we),this.hidePrismKnobs(),this.scene.addEntity(n)}},{key:"hidePrismKnobs",value:function(){var e=this;this.knobRenderables.forEach((function(t){return e.scene.remove(t)}))}},{key:"showPrismSections",value:function(e){var t,i=0,n=Object(l.a)(e);try{for(n.s();!(t=n.n()).done;){var a=t.value;if(a.section){this.sectionRenderables.length<=i&&this.sectionRenderables.push(this.createGhostSectionRenderable());var r=this.sectionRenderables[i];this.setGhostColor(r,ke),this.setRenderableTransform(r,a.section.worldPosition,a.section.worldOrientation),this.scene.addEntity(r),i++}}}catch(s){n.e(s)}finally{n.f()}for(var o=i;o<this.sectionRenderables.length;o++)this.scene.remove(this.sectionRenderables[o])}},{key:"activatePrismSection",value:function(e,t){var i,n=-1,a=Object(l.a)(e);try{for(a.s();!(i=a.n()).done;){var r=i.value;if(r.section&&(n++,r===t))break}}catch(s){a.e(s)}finally{a.f()}var o=this.sectionRenderables[n];this.setGhostColor(o,we),this.hidePrismSections(),this.scene.addEntity(o)}},{key:"hidePrismSections",value:function(){var e=this;this.sectionRenderables.forEach((function(t){return e.scene.remove(t)}))}},{key:"render",value:function(){var e=this;return Object(he.jsx)("canvas",{className:"Viewport",ref:function(t){return e.filament=t}})}}]),i}(n.Component),Ee=i(2),Le=i.n(Ee),Ne=i(86),Je=function(e){Object(u.a)(i,e);var t=Object(f.a)(i);function i(e){var n;return Object(h.a)(this,i),(n=t.call(this,e)).state={displayColorPicker:!1},n}return Object(d.a)(i,[{key:"handleToggleColorPicker",value:function(){this.setState({displayColorPicker:!this.state.displayColorPicker})}},{key:"handleHideColorPicker",value:function(){this.setState({displayColorPicker:!1})}},{key:"handleColorChange",value:function(e){this.props.onChange(e.hex),this.handleHideColorPicker()}},{key:"render",value:function(){var e=this,t=Le()({default:{color:{width:"36px",height:"14px",borderRadius:"2px",background:this.props.color},swatch:{padding:"5px",background:"#fff",borderRadius:"1px",boxShadow:"0 0 0 1px rgba(0,0,0,.1)",display:"inline-block",cursor:"pointer"},popover:{position:"absolute",zIndex:"2"},cover:{position:"fixed",top:"0px",right:"0px",bottom:"0px",left:"0px"}}});return Object(he.jsxs)("div",{children:[Object(he.jsx)("div",{style:t.swatch,onClick:function(){return e.handleToggleColorPicker()},children:Object(he.jsx)("div",{style:t.color})}),this.state.displayColorPicker?Object(he.jsxs)("div",{style:t.popover,children:[Object(he.jsx)("div",{style:t.cover,onClick:function(){return e.handleHideColorPicker()}}),Object(he.jsx)(Ne.a,{color:this.props.color,width:"220px",height:"220px",onChange:function(t){return e.handleColorChange(t)}})]}):null]})}}]),i}(n.Component),Ge=function(e){Object(u.a)(i,e);var t=Object(f.a)(i);function i(){return Object(h.a)(this,i),t.apply(this,arguments)}return Object(d.a)(i,[{key:"modifyShape",value:function(e,t){var i=e.clone();t(i),i.applyTransform(),this.props.onShapeChange(i)}},{key:"modifyPlaceable",value:function(e,t,i){this.modifyShape(e,(function(e){var n=e.findPlaceable(t.id);i(n)}))}},{key:"handleNameChange",value:function(e,t){this.modifyShape(e,(function(e){return e.name=t}))}},{key:"handleRollChange",value:function(e,t){this.modifyShape(e,(function(e){return e.roll=parseFloat(t)||0}))}},{key:"handlePitchChange",value:function(e,t){this.modifyShape(e,(function(e){return e.pitch=parseFloat(t)||0}))}},{key:"handleYawChange",value:function(e,t){this.modifyShape(e,(function(e){return e.yaw=parseFloat(t)||0}))}},{key:"handleShowPoseChange",value:function(e,t){this.modifyShape(e,(function(e){return e.showPose=t}))}},{key:"handleColorMaskChange",value:function(e,t,i){this.modifyPlaceable(e,t,(function(e){return e.colorMask=parseInt(i)||0}))}},{key:"handleBackgroundColorChange",value:function(e,t,i){this.modifyPlaceable(e,t,(function(e){return e.backgroundColor=i}))}},{key:"handleForegroundColorChange",value:function(e,t,i){this.modifyPlaceable(e,t,(function(e){return e.foregroundColor=i}))}},{key:"handleSwapColors",value:function(e,t){this.modifyPlaceable(e,t,(function(e){e.foregroundColor=t.backgroundColor,e.backgroundColor=t.foregroundColor}))}},{key:"handleDeletePrism",value:function(e,t){this.modifyShape(e,(function(e){e.prisms=e.prisms.filter((function(e){return e.id!==t.id})),e.sections=e.sections.filter((function(e){return e.basePrismId!==t.id&&e.targetPrismId!==t.id}))}))}},{key:"handleSectionTypeChange",value:function(e,t,i){this.modifyPlaceable(e,t,(function(e){e.type=parseInt(i)}))}},{key:"handleSectionPropertyChange",value:function(e,t,i,n){this.modifyPlaceable(e,t,(function(e){e.setPropertyValue(i,parseFloat(n))}))}},{key:"handleSwapSection",value:function(e,t){this.modifyPlaceable(e,t,(function(e){e.swap()}))}},{key:"handleDeleteSection",value:function(e,t){this.modifyShape(e,(function(e){e.sections=e.sections.filter((function(e){return e.id!==t.id}))}))}},{key:"handleConfigChange",value:function(e,t,i){var n=JSON.parse(JSON.stringify(e));i="hiddenLayerSizes"===t?i.split(",").map(Number):parseFloat(i)||0,n[t]=i,this.props.onConfigChange(n)}},{key:"formatTime",value:function(e){return Math.floor(e/60)+":"+(e%60).toString().padStart(2,"0")}},{key:"getPropertyLabel",value:function(e){return e.split(/(?=[A-Z])/).map((function(e){return e.charAt(0).toUpperCase()+e.slice(1)})).join(" ")}},{key:"renderShapeParams",value:function(e,t){var i=this;return Object(he.jsxs)("div",{className:"Group",children:[Object(he.jsx)("h3",{children:"Shape"}),Object(he.jsxs)("p",{children:[Object(he.jsx)("label",{htmlFor:"name",children:"Name : "}),Object(he.jsx)("input",{type:"text",id:"name",name:"name",value:t.name,onChange:function(e){return i.handleNameChange(t,e.target.value)}})]}),Object(he.jsxs)("p",{children:[Object(he.jsx)("label",{htmlFor:"roll",children:"Roll : "}),Object(he.jsx)("input",{type:"number",id:"roll",name:"roll",min:"-180",max:"180",step:"15",value:t.roll,onChange:function(e){return i.handleRollChange(t,e.target.value)}})]}),Object(he.jsxs)("p",{children:[Object(he.jsx)("label",{htmlFor:"pitch",children:"Pitch : "}),Object(he.jsx)("input",{type:"number",id:"pitch",name:"pitch",min:"-180",max:"180",step:"15",value:t.pitch,onChange:function(e){return i.handlePitchChange(t,e.target.value)}})]}),Object(he.jsxs)("p",{children:[Object(he.jsx)("label",{htmlFor:"yaw",children:"Yaw : "}),Object(he.jsx)("input",{type:"number",id:"yaw",name:"yaw",min:"-180",max:"180",step:"15",value:t.yaw,onChange:function(e){return i.handleYawChange(t,e.target.value)}})]}),Object(he.jsxs)("p",{children:[Object(he.jsx)("input",{type:"checkbox",id:"showPose",name:"showPose",checked:t.showPose,onChange:function(e){return i.handleShowPoseChange(t,e.target.checked)}}),Object(he.jsx)("label",{htmlFor:"showPose",children:"Show pose"})]}),Object(he.jsx)("h3",{children:"File"}),Object(he.jsxs)("p",{children:[Object(he.jsx)("button",{id:"resetShape",name:"resetShape",onClick:function(){return i.props.onShapeReset()},children:"Reset"}),Object(he.jsx)("button",{id:"showcaseShape",name:"showcaseShape",onClick:function(){return i.props.onShapeShowcase()},children:"Showcase"})]}),Object(he.jsxs)("p",{children:[Object(he.jsx)("button",{id:"saveArchive",name:"saveArchive",onClick:function(){return i.props.onArchiveSave()},children:"Save"}),Object(he.jsx)("button",{id:"loadArchive",name:"loadArchive",onClick:function(){return i.props.onArchiveLoad()},children:"Load"})]}),Object(he.jsx)("h3",{children:"Training"}),Object(he.jsx)("button",{id:"startTraining",name:"startTraining",disabled:this.props.mode!==st.EDIT,onClick:function(){return i.props.onTrainingStart()},children:"Start"}),Object(he.jsx)("button",{id:"stopTraining",name:"stopTraining",disabled:this.props.mode!==st.TRAINING&&this.props.mode!==st.PLAY,onClick:function(){return i.props.onTrainingStop()},children:"Stop"}),Object(he.jsx)("button",{id:"playTraining",name:"playTraining",disabled:this.props.mode!==st.EDIT,onClick:function(){return i.props.onTrainingPlay()},children:"Play"}),this.props.mode===st.TRAINING&&Object(he.jsx)("p",{children:Object(he.jsxs)("label",{children:["Progress : ",this.props.trainingSteps," ~ ",Math.floor(100*this.props.trainingSteps/this.props.config.totalSteps),"%"]})}),this.props.mode===st.TRAINING&&Object(he.jsx)("p",{children:Object(he.jsxs)("label",{children:["Value : ",Math.floor(this.props.trainingValue)]})}),this.props.mode===st.TRAINING&&Object(he.jsx)("p",{children:Object(he.jsxs)("label",{children:["Time : ",this.formatTime(this.props.trainingTime)]})}),this.props.mode!==st.TRAINING&&this.props.mode!==st.PLAY&&Object.keys(e).map((function(t){var n="config_"+t,a=e[t];return Object(he.jsxs)("p",{children:[Object(he.jsxs)("label",{htmlFor:t,children:[i.getPropertyLabel(t)," : "]}),Object(he.jsx)("input",{id:n,name:n,type:Array.isArray(a)?"text":"number",value:a,onChange:function(n){return i.handleConfigChange(e,t,n.target.value)}})]},n)}))]})}},{key:"renderPrismParams",value:function(e,t){var i=this;return Object(he.jsxs)("div",{className:"Group",children:[Object(he.jsx)("h3",{children:"Prism"}),Object(he.jsxs)("p",{children:[Object(he.jsx)("label",{htmlFor:"colorMask",children:"Mask : "}),Object(he.jsx)("input",{type:"number",id:"colorMask",name:"colorMask",min:"0",max:7,step:"1",value:t.colorMask,onChange:function(n){return i.handleColorMaskChange(e,t,n.target.value)}})]}),Object(he.jsxs)("div",{children:[Object(he.jsx)("label",{htmlFor:"backgroundColor",children:"Background : "}),Object(he.jsx)(Je,{id:"backgroundColor",name:"backgroundColor",color:t.backgroundColor,onChange:function(n){return i.handleBackgroundColorChange(e,t,n)}})]}),Object(he.jsxs)("div",{children:[Object(he.jsx)("label",{htmlFor:"foregroundColor",children:"Foreground : "}),Object(he.jsx)(Je,{id:"foregroundColor",name:"foregroundColor",color:t.foregroundColor,onChange:function(n){return i.handleForegroundColorChange(e,t,n)}})]}),Object(he.jsx)("p",{children:Object(he.jsx)("button",{id:"swapColors",name:"swapColors",onClick:function(){return i.handleSwapColors(e,t)},children:"Swap"})}),Object(he.jsx)("p",{children:Object(he.jsx)("button",{id:"deletePrism",name:"deletePrism",disabled:e.prisms.length<=1,onClick:function(){return i.handleDeletePrism(e,t)},children:"Delete"})})]})}},{key:"renderSectionParams",value:function(e,t){var i=this;return Object(he.jsxs)("div",{className:"Group",children:[Object(he.jsx)("h3",{children:"Section"}),Object(he.jsxs)("p",{children:[Object(he.jsx)("label",{htmlFor:"sectionType",children:"Type : "}),Object(he.jsx)("select",{id:"sectionType",name:"sectionType",value:t.type,onChange:function(n){return i.handleSectionTypeChange(e,t,n.target.value)},children:Object.keys(ae).map((function(e){var t=ae[e];return Object(he.jsx)("option",{value:t,children:e.charAt(0)+e.substring(1).toLowerCase()},t)}))})]}),t.getProperties().map((function(n){var a="section_"+n.name;return Object(he.jsxs)("p",{children:[Object(he.jsxs)("label",{htmlFor:a,children:[i.getPropertyLabel(n.name)," : "]}),Object(he.jsx)("input",{id:a,name:a,type:"number",min:n.min,max:n.max,value:n.value,onChange:function(a){return i.handleSectionPropertyChange(e,t,n.name,a.target.value)}})]},a)})),Object(he.jsx)("p",{children:Object(he.jsx)("button",{id:"swapSection",name:"swapSection",onClick:function(){return i.handleSwapSection(e,t)},children:"Swap"})}),Object(he.jsx)("p",{children:Object(he.jsx)("button",{id:"deleteSection",name:"deleteSection",onClick:function(){return i.handleDeleteSection(e,t)},children:"Delete"})})]})}},{key:"renderParams",value:function(){var e=this.props.shape.findPlaceable(this.props.activePlaceableId);return e?e instanceof ne?this.renderPrismParams(this.props.shape,e):e instanceof se?this.renderSectionParams(this.props.shape,e):void 0:this.renderShapeParams(this.props.config,this.props.shape)}},{key:"renderHistory",value:function(){var e=this;return Object(he.jsxs)("div",{className:"Group",children:[Object(he.jsx)("h3",{children:"History"}),Object(he.jsx)("button",{id:"undoHistory",name:"undoHistory",disabled:this.props.historyIndex<=0,onClick:function(){return e.props.onHistoryChange(e.props.historyIndex-1)},children:"Undo"}),Object(he.jsx)("button",{id:"redoHistory",name:"redoHistory",disabled:this.props.historyIndex>=this.props.historyEntries.length-1,onClick:function(){return e.props.onHistoryChange(e.props.historyIndex+1)},children:"Redo"})]})}},{key:"render",value:function(){return Object(he.jsxs)("div",{className:"Toolbar",children:[this.renderHistory(),this.renderParams()]})}}]),i}(n.Component),Be=Math.PI/180,De=function(){function e(){Object(h.a)(this,e),this.pieceCount=0,this.shape=new ce}return Object(d.a)(e,[{key:"addPrism",value:function(e,t,i){var n;this.shape.prisms.length>0?n=this.shape.prisms[this.shape.prisms.length-1].getJunctions()[1].prisms[0]:n=new ne;n.id=++this.shape.lastPlaceableId,n.colorMask=e,n.backgroundColor=t,n.foregroundColor=i,this.shape.prisms.push(n),this.pieceCount++}},{key:"fold",value:function(e){var t,i=e.split("-"),n=Object(l.a)(i);try{for(n.s();!(t=n.n()).done;){var a=t.value,r=void 0,o=void 0;if(-1!==(r=a.indexOf("L")))o=!0;else{if(-1===(r=a.indexOf("R")))return!1;o=!1}var s=a.substring(0,r);if(!s)return!1;var c=2*(parseInt(s,10)-1);if(c<0||c>=this.pieceCount)return!1;var h=a.substring(r+1);if(!h)return!1;var d=parseInt(h,10);if(d){if(d<1||d>3)return!1;if(d<3){for(var u=0;u<d;u++)if(!this.twist(c,o,o))return!1}else if(!this.twist(c,o,!o))return!1}}}catch(f){n.e(f)}finally{n.f()}return!0}},{key:"twist",value:function(e,t,i){if(e<0||e>=this.pieceCount)return!1;var n=this.shape.prisms[e].getJunctions(),a=t?n[0]:n[1],r=(i?1:-1)*Math.PI/2;if(t)for(var o=e-1;o>=0;o--)this.twistPrism(o,a.pivot,a.normal,r);else for(var s=e+1;s<this.pieceCount;s++)this.twistPrism(s,a.pivot,a.normal,r);return!0}},{key:"twistPrism",value:function(e,t,i,n){var a=this.shape.prisms[e],r=F(T(a.position,a.orientation),t,i,n);p.d.copy(a.position,r.position),p.c.copy(a.orientation,r.orientation)}},{key:"applyRotations",value:function(e){if(0===e.length)return!0;var t,i=p.c.create(),n=p.c.create(),a=p.d.create(),r=Object(l.a)(e);try{for(r.s();!(t=r.n()).done;){var o=t.value;if(4!==o.length)return!1;p.d.set(a,o[0],o[2],-o[1]),p.d.normalize(a,a),p.c.setAxisAngle(n,a,o[3]*Be),p.c.multiply(i,n,i)}}catch(s){r.e(s)}finally{r.f()}return this.shape.rotate(i),!0}}],[{key:"build",value:function(t,i){var n=i.definitions.find((function(e){return e.name===t}));if(n){var a=e.compileSkin(n.skin,i);if(a){for(var r=new e,o=0;o<n.pieces;o++){var s=a.colors[o%a.colors.length];r.addPrism(a.mask,s[0],s[1])}if(r.fold(n.notation)&&r.applyRotations(n.rotations)){var l=r.shape;return l.applyTransform(),l.translate(p.d.negate(p.d.create(),l.aabb.center)),l.applyTransform(),l}}}}},{key:"compileSkin",value:function(e,t){var i="~"===e.charAt(0)?1:0,n=e.lastIndexOf(":"),a=e.substring(i,-1!==n?n:e.length),r=t.skins.definitions.find((function(e){return e.name===a}));if(r){var o=t.skins.patterns.find((function(e){return e.key===r.pattern}));if(o){var s,c=-1===n?r.mask:parseInt(e.substring(n+1)),h=[],d=Object(l.a)(o.value);try{for(d.s();!(s=d.n()).done;){var u,f=s.value,p=[],v=Object(l.a)(f);try{var m=function(){var e=u.value;if(e<1||e>r.colors.length)return{v:void 0};var i=r.colors[e-1],n=t.skins.colors.find((function(e){return e.key===i}));if(!n)return{v:void 0};p.push(n.value)};for(v.s();!(u=v.n()).done;){var g=m();if("object"===typeof g)return g.v}}catch(b){v.e(b)}finally{v.f()}h.push(p)}}catch(b){d.e(b)}finally{d.f()}return i>0&&h.reverse(),{mask:c,colors:h}}}}}]),e}();function He(e,t){return e[0].toFixed(t)+" "+e[1].toFixed(t)+" "+e[2].toFixed(t)}function ze(e){return He(e.position,6)+" "+(t=e.orientation,i=4,t[0].toFixed(i)+" "+t[1].toFixed(i)+" "+t[2].toFixed(i)+" "+t[3].toFixed(i));var t,i}var Ye=function(){function e(t){Object(h.a)(this,e),this.rigidInfo=t}return Object(d.a)(e,[{key:"export",value:function(e){var t=[];t.push("o "+e);var i,n=Object(l.a)(this.rigidInfo.links);try{for(n.s();!(i=n.n()).done;){var a=i.value;t.push("l "+a.mass.toFixed(4)+" "+He(a.inertia,4)+" "+ze(a.transform));var r,o=Object(l.a)(a.localTransforms);try{for(o.s();!(r=o.n()).done;){var s=r.value;t.push("p "+ze(s))}}catch(v){o.e(v)}finally{o.f()}}}catch(v){n.e(v)}finally{n.f()}var c,h=Object(l.a)(this.rigidInfo.joints);try{for(h.s();!(c=h.n()).done;){var d=c.value;t.push("j "+d.baseLink.index+" "+d.targetLink.index+" "+d.lowerAngle.toFixed(2)+" "+d.upperAngle.toFixed(2)+" "+d.power.toFixed(2)+" "+ze(d.transform))}}catch(v){h.e(v)}finally{h.f()}var u,f=Object(l.a)(this.rigidInfo.baseLinks);try{for(f.s();!(u=f.n()).done;){var p=u.value;t.push("b "+p.index)}}catch(v){f.e(v)}finally{f.f()}return t.join("\n")}}]),e}(),Ze=function e(){Object(h.a)(this,e),this.totalSteps=1e6,this.trainingStartSteps=1e3,this.trainingInterval=50,this.checkpointSteps=1e4,this.discount=.99,this.batchSize=100,this.randomSteps=1e4,this.replayBufferSize=1e6,this.learningRate=3e-4,this.interpolation=.995,this.hiddenLayerSizes=[64,64]};function Ue(){return new Worker(i.p+"static/js/Worker.worker.31d139a7.worker.js")}var Qe=180/Math.PI,Ke=.5*N,qe=B*Math.cos(Math.PI/4),Xe=.16666666666666669,We=T(p.d.fromValues(0,Xe,0)),_e=R(T(),We),$e=[p.d.fromValues(2*qe-1+B,-.29333333333333333,-Ke+B),p.d.fromValues(2*qe-1+B,-.29333333333333333,Ke-B),p.d.fromValues(0,.6666666666666667-2*qe,-Ke+B),p.d.fromValues(0,.6666666666666667-2*qe,Ke-B),p.d.fromValues(1-2*qe-B,-.29333333333333333,-Ke+B),p.d.fromValues(1-2*qe-B,-.29333333333333333,Ke-B)],et=1*N*(1/Math.sqrt(2)),tt=1*et*1,it=2/9*tt,nt=1/3*tt,at=2/9*tt,rt=function(){function e(t){var i=this;Object(h.a)(this,e),this.prismCollisionMargin=B,this.prismCollisionVertices=$e,this.links=[],this.baseLinks=[],this.joints=[];for(var n=t.discoverParts(),a=0;a<n.length;a++){console.log("Link "+(a+1)+"/"+n.length+":");var r=this.createLink(n[a]);r&&this.links.push(r)}var o,s=Object(l.a)(t.sections);try{for(s.s();!(o=s.n()).done;){var d=o.value;if(d.type===ae.ACTUATOR){var u=this.createJoint(t,n,d);u&&this.joints.push(u)}}}catch(v){s.e(v)}finally{s.f()}var f,p=t.discoverPartChains(n);p&&(f=this.baseLinks).push.apply(f,Object(c.a)(p.map((function(e){return i.links[n.findIndex((function(t){return t===e[0]}))]}))))}return Object(d.a)(e,[{key:"createLink",value:function(e){if(0!==e.length){var t,i=[],n=p.d.create(),a=Object(l.a)(e);try{for(a.s();!(t=a.n()).done;){var r=t.value,o=A(T(),T(r.worldPosition,r.worldOrientation),_e);p.d.add(n,n,o.position),i.push(o)}}catch(z){a.e(z)}finally{a.f()}p.d.scale(n,n,1/e.length);for(var s=p.a.fromValues(0,0,0,0,0,0,0,0,0),c=p.a.create(),h=p.a.create(),d=0,u=i;d<u.length;d++){var f=u[d],v=p.a.fromQuat(c,f.orientation),m=p.a.set(h,v[0]*it,v[3]*nt,v[6]*at,v[1]*it,v[4]*nt,v[7]*at,v[2]*it,v[5]*nt,v[8]*at);p.a.mul(m,v,m),p.a.add(s,s,m);var g=f.position,b=g[0]-n[0],y=g[1]-n[1],k=g[2]-n[2],w=b*b+y*y+k*k;p.a.set(m,w-b*b,-b*y,-b*k,-y*b,w-y*y,-y*k,-k*b,-k*y,w-k*k),p.a.multiplyScalar(m,m,et),p.a.add(s,s,m)}for(var P=p.c.fromMat3(p.c.create(),function(e,t,i){for(var n=p.a.create(),a=i;a>0;a--){var r=0,o=1,s=2,l=Math.abs(e[3]),c=Math.abs(e[6]);c>l&&(o=2,s=1,l=c),(c=Math.abs(e[7]))>l&&(r=1,o=2,s=0,l=c);var h=t*(Math.abs(e[0])+Math.abs(e[4])+Math.abs(e[8]));if(l<=h)return n;var d,u,f=e[r+3*o],v=(e[o+3*o]-e[r+3*r])/(2*f),m=v*v;h=v>=0?1/(v+Math.sqrt(1+m)):1/(v-Math.sqrt(1+m)),u=(d=1/Math.sqrt(1+h*h))*h,e[r+3*o]=0,e[o+3*r]=0,e[r+3*r]-=h*f,e[o+3*o]+=h*f;var g=e[s+3*r],b=e[s+3*o];e[s+3*r]=e[r+3*s]=d*g-u*b,e[s+3*o]=e[o+3*s]=d*b+u*g;for(var y=0;y<3;y++)g=n[y+3*r],b=n[y+3*o],n[y+3*r]=d*g-u*b,n[y+3*o]=d*b+u*g}return n}(s,1e-5,20)),C=T(n,P),j=p.d.fromValues(s[0],s[4],s[8]),x=e.length*et,O=R(T(),C),S=[],I=0,M=i;I<M.length;I++){var F=M[I],V=A(T(),O,F);S.push(V)}var E,L=[],N=Object(l.a)(e);try{for(N.s();!(E=N.n()).done;){var J=E.value,G=T(J.worldPosition,J.worldOrientation),B=A(T(),O,G);L.push(B)}}catch(z){N.e(z)}finally{N.f()}console.log("Mass: "+x),console.log("Origin: {"+n[0].toFixed(2)+", "+n[1].toFixed(2)+", "+n[2].toFixed(2)+"}"),console.log("Inertia: {"+j[0].toFixed(2)+", "+j[1].toFixed(2)+", "+j[2].toFixed(2)+"}");var D=p.d.create(),H=p.c.getAxisAngle(D,P);return console.log("Principal: axis={"+D[0].toFixed(2)+", "+D[1].toFixed(2)+", "+D[2].toFixed(2)+"} angle="+(H*Qe).toFixed(0)),{index:this.links.length,prisms:e,mass:x,inertia:j,transform:C,localTransforms:S,viewTransforms:L}}}},{key:"createJoint",value:function(e,t,i){var n=e.findPlaceable(i.basePrismId),a=e.findPlaceable(i.targetPrismId),r=t.findIndex((function(e){return e.some((function(e){return e===n}))})),o=t.findIndex((function(e){return e.some((function(e){return e===a}))}));if(-1!==r)if(-1!==o)if(r!==o){var s=this.links[r];if(s){var l=this.links[o];if(l)return{baseLink:s,targetLink:l,transform:T(i.worldPosition,i.worldOrientation),lowerAngle:i.getPropertyValue("lowerAngle"),upperAngle:i.getPropertyValue("upperAngle"),power:i.getPropertyValue("power")};console.log("Target link not found")}else console.log("Base link not found")}else console.log("Actuator must connect different parts");else console.log("Target part not found");else console.log("Base part not found")}}]),e}(),ot=".twy",st=Object.freeze({EDIT:0,TRAINING:1,PLAY:2,LOADING:3});function lt(e){for(var t=0,i=0;i<e.length;i++){t=(t<<5)-t+e.charCodeAt(i),t&=t}return t.toString(36)}var ct=function(e){Object(u.a)(i,e);var t=Object(f.a)(i);function i(e){var n;Object(h.a)(this,i),n=t.call(this,e);var a=ce.createInitialShape();return n.state={mode:st.EDIT,shape:a,activePlaceableId:0,historyEntries:[],historyIndex:-1,config:new Ze,trainingSteps:0,trainingValue:0,trainingTime:0,trainingState:null},n.figures=null,n.figureRandomIndices=null,n.figureIndex=-1,n.finalShape=a,n.rigidInfo=null,n.shapeData=null,n.checkpoint=null,n.database=null,n.worker=null,n.playing=!1,n.addHistoryEntry(n.state,a,n.finalShape,0),n}return Object(d.a)(i,[{key:"addHistoryEntry",value:function(e,t,i,n){var a=e.historyIndex+1,r=a>=30?a-30+1:0;a=Math.min(a,29),e.historyEntries=e.historyEntries.splice(r,a),e.historyEntries.push({shape:t,finalShape:i,activePlaceableId:n}),e.historyIndex=e.historyEntries.length-1}},{key:"showFigure",value:function(e){var t=De.build(e,this.figures);t&&this.handleShapeChange(t,!0)}},{key:"handleShapeChange",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;if(this.ensureEditMode()){var n={shape:e,historyEntries:this.state.historyEntries,historyIndex:this.state.historyIndex};t||this.state.activePlaceableId&&!e.findPlaceable(this.state.activePlaceableId)?n.activePlaceableId=0:i&&(n.activePlaceableId=i),e.showPose?(this.finalShape=e.clone(),this.finalShape.applyInitialAngles(),this.finalShape.hasPrismIntersections()&&console.log("Shape has intersections between prisms")):this.finalShape=e,this.addHistoryEntry(n,e,this.finalShape,n.activePlaceableId),this.setState(n)}}},{key:"handleActivePlaceableChange",value:function(e){this.setState({activePlaceableId:e})}},{key:"handleHistoryChange",value:function(e){if(this.ensureEditMode()&&!(e<0||e>=this.state.historyEntries.length)){var t=this.state.historyEntries[e];this.finalShape=t.finalShape,this.setState({shape:t.shape,activePlaceableId:t.activePlaceableId,historyIndex:e})}}},{key:"handleShapeReset",value:function(){this.handleShapeChange(ce.createInitialShape(),!0)}},{key:"handleShapeShowcase",value:function(){var e=this;if(this.figures){this.figureIndex=(this.figureIndex+1)%this.figureRandomIndices.length;var t=this.figures.definitions[this.figureRandomIndices[this.figureIndex]].name;this.showFigure(t)}else fetch("res/figures.rsf").then((function(e){return e.json()})).then((function(t){e.figures=t,e.figureRandomIndices=Object(c.a)(Array(e.figures.definitions.length).keys()).map((function(e){return{sort:Math.random(),value:e}})).sort((function(e,t){return e.sort-t.sort})).map((function(e){return e.value})),e.figureIndex=-1,e.handleShapeShowcase()}))}},{key:"handleArchiveLoad",value:function(){var e=this;this.ensureEditMode()&&this.uploadFile(ot,(function(t){var i=JSON.parse(t);if(i.version>3)alert("Unsupported version: "+i.version);else{var n=new ce;if(n.fromArchive(i.shape,i.version),n.applyTransform(),n?e.handleShapeChange(n,!0):alert("Failed to load shape"),i.version>=3){var a=i.config;a?e.handleConfigChange(a):alert("Failed to load config"),e.checkpoint=i.checkpoint}}}))}},{key:"handleArchiveSave",value:function(){if(this.state.shape.name){this.generateShapeData();var e=JSON.stringify({version:3,shape:this.state.shape.toArchive(),shapeData:this.shapeData,config:this.state.config,checkpoint:this.checkpoint});this.downloadFile(this.state.shape.name+ot,e)}else alert("Shape name must be given")}},{key:"handleConfigChange",value:function(e){this.setState({config:e})}},{key:"handleAppModeChange",value:function(e){var t=this,i={mode:e};if(null!=this.worker&&(this.worker.terminate(),this.worker=null),e===st.TRAINING||e===st.PLAY){this.generateShapeData(),this.playing=e===st.PLAY;var n,a=0,r=Object(l.a)(this.rigidInfo.joints);try{for(r.s();!(n=r.n()).done;){0!==n.value.power&&a++}}catch(o){r.e(o)}finally{r.f()}a>0?(i.mode=st.LOADING,i.trainingSteps=0,i.trainingValue=0,i.trainingTime=0):(i.mode=this.state.mode,alert("No active actuator"))}else e===st.LOADING&&(window.Worker?i.mode=this.playing?st.PLAY:st.TRAINING:(i.mode=st.EDIT,alert("No worker support")));this.setState(i),i.mode===st.LOADING?this.loadCheckpoint((function(e){e&&(e.key!==t.checkpoint.key?console.log("Checkpoint keys must be equal"):(!t.checkpoint.data||!t.checkpoint.time||e.time>t.checkpoint.time)&&(t.checkpoint=e,console.log("Use checkpoint from DB"))),t.handleAppModeChange(t.state.mode)})):i.mode!==st.TRAINING&&i.mode!==st.PLAY||(this.worker=new Ue,this.worker.onmessage=function(e){return t.handleWorkerMessage(e)},this.worker.postMessage([this.state.config,this.shapeData,this.checkpoint.data,this.playing]))}},{key:"handleWorkerMessage",value:function(e){var t=this,i=Object(s.a)(e.data,5),n=i[0],a=i[1],r=i[2],o=i[3],l=i[4];l&&(this.checkpoint.data=l,this.checkpoint.time=Date.now(),this.saveCheckpoint((function(){console.log("Save checkpoint at "+n+"/"+t.state.config.totalSteps)})));var c={trainingState:o};(this.state.trainingValue!==a||this.state.trainingTime!==r||n===this.state.config.totalSteps&&c.trainingSteps!==n)&&(c.trainingSteps=n,c.trainingValue=a,c.trainingTime=r),this.setState(c)}},{key:"generateShapeData",value:function(){var e;this.rigidInfo=new rt(this.finalShape);var t=new Ye(this.rigidInfo);this.shapeData=t.export(this.finalShape.name);var i=this.createCheckpoint(this.state.config,this.shapeData);i.key!==(null===(e=this.checkpoint)||void 0===e?void 0:e.key)&&(this.checkpoint=i)}},{key:"ensureEditMode",value:function(){var e=this.state.mode===st.EDIT;return e||alert("Stop training mode first"),e}},{key:"downloadFile",value:function(e,t){var i=document.createElement("a"),n=new Blob([t],{type:"text/plain;charset=utf-8"});i.href=URL.createObjectURL(n),i.download=e,document.body.appendChild(i),i.click()}},{key:"uploadFile",value:function(e,t){var i=document.createElement("input");i.setAttribute("type","file"),i.setAttribute("accept",e),i.addEventListener("change",(function(){if(i.files.length){var e=i.files[0],n=new FileReader;n.onload=function(e){t(e.target.result)},n.readAsText(e)}})),i.click()}},{key:"createCheckpoint",value:function(e,t){return{key:lt(e.hiddenLayerSizes.toString()+t),data:null,time:null}}},{key:"loadCheckpoint",value:function(e){var t=this;if(this.database){var i=this.database.transaction("checkpoint","readonly").objectStore("checkpoint").get(this.checkpoint.key);i.onsuccess=function(t){e(i.result)},i.onerror=function(t){console.log("Failed to load checkpoint"),e()}}else this.openDatabase((function(){t.database?t.loadCheckpoint(e):e()}))}},{key:"saveCheckpoint",value:function(e){var t=this;if(this.database){var i=this.database.transaction("checkpoint","readwrite").objectStore("checkpoint").put(this.checkpoint);i.onsuccess=function(t){return e()},i.onerror=function(e){console.log("Failed to save checkpoint")}}else this.openDatabase((function(){t.database&&t.saveCheckpoint(e)}))}},{key:"openDatabase",value:function(e){var t=this,i=indexedDB.open("database");i.onupgradeneeded=function(e){var t=e.target.result;t.objectStoreNames.contains("checkpoint")||(t.createObjectStore("checkpoint",{keyPath:"key"}),console.log("Initialize DB"))},i.onsuccess=function(n){t.database=i.result,e()},i.onerror=function(t){console.log("Failed to open DB"),e()}}},{key:"render",value:function(){var e=this;return Object(he.jsxs)("div",{className:"App",children:[Object(he.jsx)(Ve,{mode:this.state.mode,originalShape:this.state.shape,finalShape:this.finalShape,rigidInfo:this.rigidInfo,activePlaceableId:this.state.activePlaceableId,trainingState:this.state.trainingState,onShapeChange:function(t,i){return e.handleShapeChange(t,!1,i)},onActivePlaceableChange:function(t){return e.handleActivePlaceableChange(t)}}),Object(he.jsx)(Ge,{mode:this.state.mode,shape:this.state.shape,activePlaceableId:this.state.activePlaceableId,historyEntries:this.state.historyEntries,historyIndex:this.state.historyIndex,trainingSteps:this.state.trainingSteps,trainingValue:this.state.trainingValue,trainingTime:this.state.trainingTime,config:this.state.config,onShapeChange:function(t){return e.handleShapeChange(t)},onHistoryChange:function(t){return e.handleHistoryChange(t)},onShapeReset:function(){return e.handleShapeReset()},onShapeShowcase:function(){return e.handleShapeShowcase()},onArchiveSave:function(){return e.handleArchiveSave()},onArchiveLoad:function(){return e.handleArchiveLoad()},onTrainingStart:function(){return e.handleAppModeChange(st.TRAINING)},onTrainingStop:function(){return e.handleAppModeChange(st.EDIT)},onTrainingPlay:function(){return e.handleAppModeChange(st.PLAY)},onConfigChange:function(t){return e.handleConfigChange(t)}})]})}}]),i}(n.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(Object(he.jsx)(a.a.StrictMode,{children:Object(he.jsx)(ct,{})}),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},35:function(e,t,i){},97:function(e,t,i){}},[[207,1,2]]]);
//# sourceMappingURL=main.467aab9f.chunk.js.map